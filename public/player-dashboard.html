<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Personajes - Jugador</title>
    <script src="config.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/global.css">
    <link rel="stylesheet" href="styles/player-dashboard.css">
</head>
<body>
    <!-- Background effects -->
    <div class="bg-grid"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">üé≠</div>
                <div class="logo-text">
                    <h1>Game Master</h1>
                    <div class="role-badge">Player Panel</div>
                </div>
            </div>
            <div class="user-section">
                <div class="user-info">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-id" id="userId"></div>
                </div>
                <button class="btn-logout" id="logoutBtn">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main class="container">
        <div class="page-header">
            <h2 class="page-title">Mis Personajes</h2>
            <p class="page-subtitle">Gestiona tus personajes de juego</p>
            <div class="tab-bar" style="margin-top:18px;">
                <button class="tab-btn active" id="tabCharactersBtn" onclick="switchToCharactersTab()">Personajes</button>
                <button class="tab-btn" id="tabInvitationsBtn" onclick="showInvitations()">Invitaciones</button>
            </div>
        </div>

        <!-- Loading state -->
        <div id="loadingState" class="loading-container">
            <div class="spinner"></div>
            <div class="loading-text">Cargando personajes...</div>
        </div>

        <!-- Error state -->
        <div id="errorState" class="error-container" style="display: none;">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h3 class="error-title">Error al cargar personajes</h3>
            <p class="error-message" id="errorMessage"></p>
            <button class="btn-retry" onclick="loadCharacters()">Reintentar</button>
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">üé≠</div>
            <h3 class="empty-title">No tienes personajes a√∫n</h3>
            <p class="empty-message">
                Espera a que un maestro de juego te invite a una campa√±a para crear tu primer personaje.
            </p>
        </div>

        <!-- Characters list -->
        <div id="charactersContainer" style="display: none;">
            <div class="characters-header">
                <div class="characters-count">
                    <strong id="charactersCount">0</strong> personajes
                </div>
            </div>
            <div class="characters-grid" id="charactersGrid"></div>
        </div>
        <!-- Invitations list (for creating PJs from invitations) -->
        <div id="invitationsContainer" style="display: none;">
            <div class="characters-header">
                <div class="characters-count">
                    <strong id="invitationsCount">0</strong> invitaciones
                </div>
            </div>
            <div id="invitationsList" class="invitations-list"></div>
        </div>
    </main>

    <!-- Character Details Modal -->
    <!-- Character Details Modal (Combined view & edit) -->
    <div class="modal-overlay" id="characterModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title-section">
                    <div class="modal-icon">üë§</div>
                    <h3 class="modal-title" id="characterModalName">Detalles del Personaje</h3>
                    <p class="modal-subtitle" id="characterModalType"></p>
                </div>
                <button class="btn-close" onclick="closeCharacterModal()">√ó</button>
            </div>

            <div class="modal-body">
                <div id="characterModalAlert" class="modal-alert"></div>
                <div id="characterModalContent" class="character-modal-content">
                    <!-- Content will be dynamically loaded -->
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeCharacterModal()">Cerrar</button>
                <button class="btn-primary" id="btnSavePJStats" onclick="savePJStats()" style="display: none;">
                    <span>üíæ</span>
                    <span>Guardar Cambios</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Stats Modal -->

    <!-- Create PJ Modal (from invitation) -->
    <div class="modal-overlay" id="createPJModal">
        <div class="modal" style="max-width:820px;">
            <div class="modal-header">
                <div class="modal-title-section">
                    <div class="modal-icon">üõ°Ô∏è</div>
                    <h3 class="modal-title">Crear Personaje desde Invitaci√≥n</h3>
                    <p class="modal-subtitle" id="createPJCampaignName"></p>
                </div>
                <button class="btn-close" onclick="closeCreatePJModal()">√ó</button>
            </div>

            <div class="modal-body">
                <div class="form-row">
                    <label>Nombre</label>
                    <input type="text" id="pjNameInput" placeholder="Nombre del personaje" style="width:100%; padding:8px; margin-top:6px;">
                </div>

                <div class="form-row" style="margin-top:12px;">
                    <label>Tipo</label>
                    <select id="pjTypeInput" style="width:100%; padding:8px; margin-top:6px;">
                        <option value="human">Humano</option>
                        <option value="supernatural">Sobrenatural</option>
                    </select>
                </div>

                <div class="form-row-group" style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:140px;">
                        <label>Peso (kg)</label>
                        <input id="pjWeightInput" type="number" min="1" value="70" style="width:100%; padding:8px; margin-top:6px;">
                    </div>
                    <div style="flex:1; min-width:140px;">
                        <label>Altura (cm)</label>
                        <input id="pjHeightInput" type="number" min="1" value="170" style="width:100%; padding:8px; margin-top:6px;">
                    </div>
                    <div style="flex:1; min-width:140px;">
                        <label>Edad</label>
                        <input id="pjAgeInput" type="number" min="0" value="25" style="width:100%; padding:8px; margin-top:6px;">
                    </div>
                    <div style="flex:1; min-width:140px;">
                        <label>Apariencia (1-20)</label>
                        <input id="pjLookInput" type="number" min="1" max="20" value="10" style="width:100%; padding:8px; margin-top:6px;">
                    </div>
                </div>

                <div class="form-row-group" style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:160px;">
                        <label>Carisma (-10 a 10)</label>
                        <input id="pjCharismaInput" type="number" min="-10" max="10" value="0" style="width:100%; padding:8px; margin-top:6px;">
                    </div>
                    <div style="flex:1; min-width:160px;">
                        <label>Villan√≠a (0-10)</label>
                        <input id="pjVillainyInput" type="number" min="0" max="10" value="0" style="width:100%; padding:8px; margin-top:6px;">
                    </div>
                    <div style="flex:1; min-width:160px;">
                        <label>Hero√≠smo (0-10)</label>
                        <input id="pjHeroismInput" type="number" min="0" max="10" value="5" style="width:100%; padding:8px; margin-top:6px;">
                    </div>
                </div>

                <div style="margin-top:14px; display:flex; gap:12px; flex-wrap:wrap;">
                    <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="pjIsPhysicalTalented"> Talento F√≠sico</label>
                    <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="pjIsMentalTalented"> Talento Mental</label>
                    <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="pjIsCoordinationTalented"> Talento Coordinaci√≥n</label>
                    <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="pjIsEnergyTalented"> Talento Energ√≠a</label>
                </div>

                <div style="margin-top:8px; display:flex; gap:12px; flex-wrap:wrap;">
                    <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="pjIsPhysicalSkillsTalented"> Habilidades F√≠sicas Talentosas</label>
                    <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="pjIsMentalSkillsTalented"> Habilidades Mentales Talentosas</label>
                    <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="pjIsEnergySkillsTalented"> Habilidades de Energ√≠a Talentosas</label>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeCreatePJModal()">Cancelar</button>
                <button class="btn-primary" id="btnCreatePJ" onclick="createPJFromInvitation()">Crear Personaje</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = window?.ENV?.API_BASE_URL || 'http://localhost:3000';

        // State
        let characters = [];
        let currentPJ = null;
        let originalStats = null;
        let currentStats = null;

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update user info in header
        async function updateUserInfo() {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/users/self`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    document.getElementById('userName').textContent = userData.username || 'Jugador';
                    if (userData.id) {
                        document.getElementById('userId').textContent = `ID: ${userData.id.substring(0, 8)}...`;
                    }
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
            }
        }

        // Show loading state
        function showLoading() {
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('charactersContainer').style.display = 'none';
        }

        // Show error state
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('charactersContainer').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
        }

        // Show empty state
        function showEmpty() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('charactersContainer').style.display = 'none';
        }

        // Show characters
        function showCharacters() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('charactersContainer').style.display = 'block';
            
            document.getElementById('charactersCount').textContent = characters.length;
            renderCharacters();
        }

        // Load characters
        async function loadCharacters() {
            showLoading();
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/pjs`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = 'login.html';
                    return;
                }

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || `Error ${response.status}`);
                }

                characters = await response.json();

                if (!Array.isArray(characters)) {
                    throw new Error('Respuesta inv√°lida del servidor');
                }

                if (characters.length === 0) {
                    showEmpty();
                } else {
                    showCharacters();
                }

            } catch (error) {
                console.error('Error loading characters:', error);
                showError(error.message || 'Error de conexi√≥n. Verifica tu conexi√≥n a internet.');
            } finally {
                // Ensure loading spinner is hidden even if an unexpected error occurs
                try { document.getElementById('loadingState').style.display = 'none'; } catch (e) { /* ignore */ }
            }
        }

        // Render characters grid
        function renderCharacters() {
            const grid = document.getElementById('charactersGrid');
            try {
                grid.innerHTML = characters.map((character, index) => `
                    <div class="character-card" onclick="viewCharacter('${character.id}')" style="animation-delay: ${index * 0.1}s">
                        <div class="character-header">
                            <div class="character-icon">üë§</div>
                            <div class="character-id">#${character.id ? character.id.substring(0, 8) : '----'}</div>
                        </div>
                        <h3 class="character-name">${escapeHtml(character.name || 'Sin nombre')}</h3>
                        <div class="character-actions">
                            <button class="btn-action" onclick="event.stopPropagation(); viewCharacter('${character.id}')">
                                Ver Detalles
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error rendering characters:', err);
                // Fallback to empty state to avoid leaving spinner visible
                showEmpty();
            }
        }

        // View character details
        async function viewCharacter(characterId) {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/pjs/${characterId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = 'login.html';
                    return;
                }

                if (response.status === 403) {
                    alert('No tienes permisos para ver este personaje');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Error al cargar los detalles del personaje');
                }

                const pj = await response.json();
                currentPJ = pj;
                openCharacterModal(pj);

            } catch (error) {
                console.error('Error loading character details:', error);
                alert('Error al cargar los detalles del personaje');
            }
        }

        // Open character modal
        function openCharacterModal(pj) {
            document.getElementById('characterModalName').textContent = pj.name;
            document.getElementById('characterModalType').textContent = pj.pj_type === 'human' ? 'Personaje Humano' : 'Personaje Sobrenatural';

            // Store original stats for change detection
            originalStats = JSON.parse(JSON.stringify(pj));
            currentStats = JSON.parse(JSON.stringify(pj));

            const warningIcon = (fieldName) => {
                const watchId = `stat-${fieldName}`;
                const button = `onclick="checkStatChange('${fieldName}')"`;
                return `<span class="stat-warning" id="warning-${fieldName}" style="display:none; margin-left:8px; color:#ff4a9e; font-size:14px;" title="‚ö†Ô∏è Este valor ha sido modificado">‚ö†Ô∏è</span>`;
            };

            const statInput = (label, id, value, min = 0, max = 100) => `
                <div class="pj-stat">
                    <div class="pj-stat-label">
                        ${label}
                        <span class="stat-warning" id="warning-${id}" style="display:none; color:#ff4a9e; margin-left:4px;" title="Este valor ha sido modificado">‚ö†Ô∏è</span>
                    </div>
                    <input type="number" id="stat-${id}" min="${min}" max="${max}" value="${value}" 
                           class="pj-stat-input" 
                           onchange="checkStatChange('${id}')"
                           onkeyup="checkStatChange('${id}')" />
                </div>
            `;

            const content = `
                <div class="pj-stats-section">
                    <div class="pj-stats-title">üë§ Caracter√≠sticas Personales</div>
                    <div class="pj-info-grid">
                        <div class="pj-info-item">
                            <div class="pj-info-label">Edad <span class="stat-warning" id="warning-age" style="display:none; color:#ff4a9e;">‚ö†Ô∏è</span></div>
                            <input type="number" id="stat-age" min="0" value="${pj.age}" class="pj-info-input" onchange="checkStatChange('age')" onkeyup="checkStatChange('age')" />
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Altura (cm) <span class="stat-warning" id="warning-height" style="display:none; color:#ff4a9e;">‚ö†Ô∏è</span></div>
                            <input type="number" id="stat-height" min="1" value="${pj.height}" class="pj-info-input" onchange="checkStatChange('height')" onkeyup="checkStatChange('height')" />
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Peso <span class="stat-warning" id="warning-weight" style="display:none; color:#ff4a9e;">‚ö†Ô∏è</span></div>
                            <input type="text" id="stat-weight" value="${pj.weight}" class="pj-info-input" onchange="checkStatChange('weight')" onkeyup="checkStatChange('weight')" />
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Apariencia (1-20) <span class="stat-warning" id="warning-look" style="display:none; color:#ff4a9e;">‚ö†Ô∏è</span></div>
                            <input type="number" id="stat-look" min="1" max="20" value="${pj.look}" class="pj-info-input" onchange="checkStatChange('look')" onkeyup="checkStatChange('look')" />
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">‚ù§Ô∏è Vida <span class="stat-warning" id="warning-life" style="display:none; color:#ff4a9e;">‚ö†Ô∏è</span></div>
                            <input type="number" id="stat-life" min="0" value="${pj.basic_stats.life}" class="pj-info-input" onchange="checkStatChange('life')" onkeyup="checkStatChange('life')" />
                        </div>
                    </div>
                </div>

                <div class="pj-stats-section">
                    <div class="pj-stats-title">üí™ Stats F√≠sicos B√°sicos ${pj.basic_stats.physical.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        ${statInput('Fuerza', 'strength', pj.basic_stats.physical.strength)}
                        ${statInput('Agilidad', 'agility', pj.basic_stats.physical.agility)}
                        ${statInput('Velocidad', 'speed', pj.basic_stats.physical.speed)}
                        ${statInput('Resistencia', 'resistance', pj.basic_stats.physical.resistance)}
                    </div>
                </div>

                <div class="pj-stats-section">
                    <div class="pj-stats-title">üß† Stats Mentales B√°sicos ${pj.basic_stats.mental.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        ${statInput('Inteligencia', 'intelligence', pj.basic_stats.mental.intelligence)}
                        ${statInput('Sabidur√≠a', 'wisdom', pj.basic_stats.mental.wisdom)}
                        ${statInput('Concentraci√≥n', 'concentration', pj.basic_stats.mental.concentration)}
                        ${statInput('Voluntad', 'will', pj.basic_stats.mental.will)}
                    </div>
                </div>

                <div class="pj-stats-section">
                    <div class="pj-stats-title">üéØ Stats de Coordinaci√≥n B√°sicos ${pj.basic_stats.coordination.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        ${statInput('Precisi√≥n', 'precision', pj.basic_stats.coordination.precision)}
                        ${statInput('C√°lculo', 'calculation', pj.basic_stats.coordination.calculation)}
                        ${statInput('Alcance', 'range', pj.basic_stats.coordination.range)}
                        ${statInput('Reflejos', 'reflexes', pj.basic_stats.coordination.reflexes)}
                    </div>
                </div>

                <div class="pj-stats-section">
                    <div class="pj-stats-title">üí• Habilidades F√≠sicas Especiales ${pj.special_stats.physical.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid" style="grid-template-columns: repeat(2, 1fr);">
                        ${statInput('Potenciaci√≥n', 'empowerment', pj.special_stats.physical.empowerment)}
                        ${statInput('Control Vital', 'vital-control', pj.special_stats.physical.vital_control)}
                    </div>
                </div>

                <div class="pj-stats-section">
                    <div class="pj-stats-title">üîÆ Habilidades Mentales Especiales ${pj.special_stats.mental.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid" style="grid-template-columns: repeat(2, 1fr);">
                        ${statInput('Ilusi√≥n', 'illusion', pj.special_stats.mental.illusion)}
                        ${statInput('Control Mental', 'mental-control', pj.special_stats.mental.mental_control)}
                    </div>
                </div>

                <div class="pj-stats-section">
                    <div class="pj-stats-title">‚ö° Habilidades de Energ√≠a ${pj.special_stats.energy.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        ${statInput('Manejo de Objetos', 'object-handling', pj.special_stats.energy.object_handling)}
                        ${statInput('Manejo de Energ√≠a', 'energy-handling', pj.special_stats.energy.energy_handling)}
                        ${statInput('Tanque de Energ√≠a', 'energy-tank', pj.special_stats.energy_tank)}
                    </div>
                </div>

                <div class="pj-xp">
                    <div class="pj-xp-item">
                        <div class="pj-xp-label">XP B√°sico</div>
                        <div class="pj-xp-value">${pj.xp.basic}</div>
                    </div>
                    <div class="pj-xp-item">
                        <div class="pj-xp-label">XP Especial</div>
                        <div class="pj-xp-value">${pj.xp.special}</div>
                    </div>
                    <div class="pj-xp-item">
                        <div class="pj-xp-label">XP Sobrenatural</div>
                        <div class="pj-xp-value">${pj.xp.supernatural}</div>
                    </div>
                </div>
                <div class="pj-spent-xp">
                    <div class="pj-spent-xp-title">XP Gastado</div>
                    <div class="pj-xp-item">
                        <div class="pj-xp-label">Gastado B√°sico</div>
                        <div class="pj-xp-value">${pj.spent_xp?.basic ?? 0}</div>
                    </div>
                    <div class="pj-xp-item">
                        <div class="pj-xp-label">Gastado Especial</div>
                        <div class="pj-xp-value">${pj.spent_xp?.special ?? 0}</div>
                    </div>
                    <div class="pj-xp-item">
                        <div class="pj-xp-label">Gastado Sobrenatural</div>
                        <div class="pj-xp-value">${pj.spent_xp?.supernatural ?? 0}</div>
                    </div>
                </div>
            `;

            document.getElementById('characterModalContent').innerHTML = content;
            document.getElementById('btnSavePJStats').style.display = 'none';
            document.getElementById('characterModal').classList.add('show');
        }

        // Check if a stat has changed and toggle warning icon
        function checkStatChange(fieldName) {
            const inputEl = document.getElementById(`stat-${fieldName}`);
            const warningEl = document.getElementById(`warning-${fieldName}`);
            if (!inputEl) return;

            let originalValue, currentValue;
            
            // Get values based on field name
            if (fieldName === 'age') {
                originalValue = originalStats.age;
                currentValue = parseInt(inputEl.value);
            } else if (fieldName === 'height') {
                originalValue = originalStats.height;
                currentValue = parseInt(inputEl.value);
            } else if (fieldName === 'weight') {
                originalValue = originalStats.weight;
                currentValue = inputEl.value;
            } else if (fieldName === 'look') {
                originalValue = originalStats.look;
                currentValue = parseInt(inputEl.value);
            } else if (fieldName === 'life') {
                originalValue = originalStats.basic_stats.life;
                currentValue = parseInt(inputEl.value);
            } else if (['strength', 'agility', 'speed', 'resistance'].includes(fieldName)) {
                originalValue = originalStats.basic_stats.physical[fieldName];
                currentValue = parseInt(inputEl.value);
            } else if (['intelligence', 'wisdom', 'concentration', 'will'].includes(fieldName)) {
                originalValue = originalStats.basic_stats.mental[fieldName];
                currentValue = parseInt(inputEl.value);
            } else if (['precision', 'calculation', 'range', 'reflexes'].includes(fieldName)) {
                originalValue = originalStats.basic_stats.coordination[fieldName];
                currentValue = parseInt(inputEl.value);
            } else if (['empowerment', 'vital-control'].includes(fieldName)) {
                const key = fieldName.replace('-', '_');
                originalValue = originalStats.special_stats.physical[key];
                currentValue = parseInt(inputEl.value);
            } else if (['illusion', 'mental-control'].includes(fieldName)) {
                const key = fieldName.replace('-', '_');
                originalValue = originalStats.special_stats.mental[key];
                currentValue = parseInt(inputEl.value);
            } else if (['object-handling', 'energy-handling'].includes(fieldName)) {
                const key = fieldName.replace('-', '_');
                originalValue = originalStats.special_stats.energy[key];
                currentValue = parseInt(inputEl.value);
            } else if (fieldName === 'energy-tank') {
                originalValue = originalStats.special_stats.energy_tank;
                currentValue = parseInt(inputEl.value);
            }

            // Toggle warning icon if value changed
            if (warningEl) {
               warningEl.style.display = (originalValue !== currentValue) ? 'inline' : 'none';
            }

            // Show save button if any changes exist
            updateSaveButtonVisibility();
        }

        // Check if there are any changes and show save button accordingly
        function updateSaveButtonVisibility() {
            const inputs = document.querySelectorAll('.pj-stat-input, .pj-info-input');
            let hasChanges = false;

            inputs.forEach(input => {
                const warning = input.parentElement.querySelector('.stat-warning');
                if (warning && warning.style.display !== 'none') {
                    hasChanges = true;
                }
            });

            document.getElementById('btnSavePJStats').style.display = hasChanges ? 'inline-flex' : 'none';
        }

        // Close character modal
        function closeCharacterModal() {
            document.getElementById('characterModal').classList.remove('show');
        }

        // Save PJ Stats function
        async function savePJStats() {
            if (!currentPJ) return;

            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            const btnSave = document.getElementById('btnSavePJStats');
            btnSave.classList.add('loading');
            btnSave.disabled = true;

            try {
                const requestBody = {
                    age: parseInt(document.getElementById('stat-age').value),
                    height: parseInt(document.getElementById('stat-height').value),
                    weight: document.getElementById('stat-weight').value,
                    look: parseInt(document.getElementById('stat-look').value),
                    basic_stats: {
                        physical: {
                            strength: parseInt(document.getElementById('stat-strength').value),
                            agility: parseInt(document.getElementById('stat-agility').value),
                            speed: parseInt(document.getElementById('stat-speed').value),
                            resistance: parseInt(document.getElementById('stat-resistance').value)
                        },
                        mental: {
                            intelligence: parseInt(document.getElementById('stat-intelligence').value),
                            wisdom: parseInt(document.getElementById('stat-wisdom').value),
                            concentration: parseInt(document.getElementById('stat-concentration').value),
                            will: parseInt(document.getElementById('stat-will').value)
                        },
                        coordination: {
                            precision: parseInt(document.getElementById('stat-precision').value),
                            calculation: parseInt(document.getElementById('stat-calculation').value),
                            range: parseInt(document.getElementById('stat-range').value),
                            reflexes: parseInt(document.getElementById('stat-reflexes').value)
                        },
                        life: parseInt(document.getElementById('stat-life').value)
                    },
                    special_stats: {
                        physical: {
                            empowerment: parseInt(document.getElementById('stat-empowerment').value),
                            vital_control: parseInt(document.getElementById('stat-vital-control').value)
                        },
                        mental: {
                            illusion: parseInt(document.getElementById('stat-illusion').value),
                            mental_control: parseInt(document.getElementById('stat-mental-control').value)
                        },
                        energy: {
                            object_handling: parseInt(document.getElementById('stat-object-handling').value),
                            energy_handling: parseInt(document.getElementById('stat-energy-handling').value)
                        },
                        energy_tank: parseInt(document.getElementById('stat-energy-tank').value)
                    }
                };

                // Add supernatural stats if applicable
                if (currentPJ.pj_type === 'supernatural' && currentPJ.supernatural_stats) {
                    requestBody.supernatural_stats = currentPJ.supernatural_stats;
                }

                const response = await fetch(`${API_BASE_URL}/api/v1/pjs/${currentPJ.id}/stats`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = 'login.html';
                    return;
                }

                if (response.status === 403) {
                    showCharacterAlert('No tienes permisos para editar este personaje', 'error');
                    return;
                }

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    showCharacterAlert(error.error || 'Error al actualizar personaje', 'error');
                    return;
                }

                const updatedPJ = await response.json();
                currentPJ = updatedPJ;
                originalStats = JSON.parse(JSON.stringify(updatedPJ));

                showCharacterAlert('Cambios guardados correctamente', 'success');
                
                // Reload the modal with updated data
                setTimeout(() => {
                    openCharacterModal(updatedPJ);
                }, 1500);

            } catch (error) {
                console.error('Error saving stats:', error);
                showCharacterAlert(error.message || 'Error de conexi√≥n', 'error');
            } finally {
                btnSave.classList.remove('loading');
                btnSave.disabled = false;
            }
        }

        // Show/hide alert in character modal
        function showCharacterAlert(message, type = 'error') {
            const alert = document.getElementById('characterModalAlert');
            alert.textContent = message;
            alert.className = `modal-alert ${type} show`;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }

        // Close modals on overlay click
        document.getElementById('characterModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCharacterModal();
            }
        });

        document.getElementById('createPJModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCreatePJModal();
            }
        });

        // Close modals on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('characterModal').classList.contains('show')) {
                    closeCharacterModal();
                } else if (document.getElementById('createPJModal').classList.contains('show')) {
                    closeCreatePJModal();
                }
            }
        });

        // ----- Invitations / Create PJ from Invitation -----
        let currentInvitationId = null;
        let currentInvitationCampaignId = null;

        function switchToCharactersTab() {
            document.getElementById('tabCharactersBtn').classList.add('active');
            document.getElementById('tabInvitationsBtn').classList.remove('active');
            document.getElementById('charactersContainer').style.display = 'block';
            document.getElementById('invitationsContainer').style.display = 'none';
        }

        function showInvitations() {
            document.getElementById('tabCharactersBtn').classList.remove('active');
            document.getElementById('tabInvitationsBtn').classList.add('active');
            document.getElementById('charactersContainer').style.display = 'none';
            document.getElementById('invitationsContainer').style.display = 'block';
            loadInvitations();
        }

        async function loadInvitations() {
            const token = localStorage.getItem('authToken');
            if (!token) return;
            try {
                const res = await fetch(`${API_BASE_URL}/api/v1/invitations`, {
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                });
                if (res.status === 401) { localStorage.removeItem('authToken'); window.location.href = 'login.html'; return; }
                if (!res.ok) { throw new Error('Error cargando invitaciones'); }
                const invites = await res.json();
                renderInvitations(invites);
            } catch (err) {
                console.error('Error loading invitations:', err);
                document.getElementById('invitationsList').innerHTML = '<div class="error-message">No se pudieron cargar las invitaciones.</div>';
            }
        }

        function renderInvitations(invites) {
            document.getElementById('invitationsCount').textContent = Array.isArray(invites) ? invites.length : 0;
            if (!Array.isArray(invites) || invites.length === 0) {
                document.getElementById('invitationsList').innerHTML = '<div class="empty-state">No hay invitaciones disponibles.</div>';
                return;
            }

            document.getElementById('invitationsList').innerHTML = invites.map(inv => {
                const campaignName = (inv.campaign && inv.campaign.name) ? escapeHtml(inv.campaign.name) : (inv.campaign_name ? escapeHtml(inv.campaign_name) : 'Campa√±a');
                const stateRaw = (inv.state || 'pending').toString();
                const state = escapeHtml(stateRaw);
                const isAccepted = stateRaw.toLowerCase() === 'accepted' || stateRaw.toLowerCase() === 'acepted';
                return `
                    <div class="invitation-item">
                        <div class="invitation-info">
                            <div class="invitation-campaign">${campaignName}</div>
                            <div class="invitation-meta">Estado: <strong>${state}</strong></div>
                        </div>
                        <div class="invitation-actions">
                            ${isAccepted ? '<span class="badge success">Aceptada</span>' : `<button class="btn-action" onclick="openCreatePJModal('${inv.id}', '${inv.campaign_id || (inv.campaign && inv.campaign.id) || ''}', '${campaignName.replace(/'/g, "\\'")}')">Crear PJ</button>`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openCreatePJModal(invitationId, campaignId, campaignName) {
            currentInvitationId = invitationId;
            currentInvitationCampaignId = campaignId;
            document.getElementById('createPJCampaignName').textContent = campaignName || 'Campa√±a';
            // set defaults
            document.getElementById('pjNameInput').value = '';
            document.getElementById('pjTypeInput').value = 'human';
            document.getElementById('pjWeightInput').value = 70;
            document.getElementById('pjHeightInput').value = 170;
            document.getElementById('pjAgeInput').value = 25;
            document.getElementById('pjLookInput').value = 10;
            document.getElementById('pjCharismaInput').value = 0;
            document.getElementById('pjVillainyInput').value = 0;
            document.getElementById('pjHeroismInput').value = 5;
            document.getElementById('pjIsPhysicalTalented').checked = false;
            document.getElementById('pjIsMentalTalented').checked = false;
            document.getElementById('pjIsCoordinationTalented').checked = false;
            document.getElementById('pjIsEnergyTalented').checked = false;
            document.getElementById('pjIsPhysicalSkillsTalented').checked = false;
            document.getElementById('pjIsMentalSkillsTalented').checked = false;
            document.getElementById('pjIsEnergySkillsTalented').checked = false;
            document.getElementById('createPJModal').classList.add('show');
        }

        function closeCreatePJModal() {
            document.getElementById('createPJModal').classList.remove('show');
            currentInvitationId = null;
            currentInvitationCampaignId = null;
        }

        async function createPJFromInvitation() {
            const token = localStorage.getItem('authToken');
            if (!token) { window.location.href = 'login.html'; return; }
            if (!currentInvitationCampaignId) { alert('Campaign ID missing'); return; }

            const name = document.getElementById('pjNameInput').value.trim();
            const type = document.getElementById('pjTypeInput').value;
            const weight = parseInt(document.getElementById('pjWeightInput').value) || undefined;
            const height = parseInt(document.getElementById('pjHeightInput').value) || undefined;
            const age = parseInt(document.getElementById('pjAgeInput').value) || undefined;
            const look = parseInt(document.getElementById('pjLookInput').value) || 1;
            const charisma = parseInt(document.getElementById('pjCharismaInput').value) || 0;
            const villainy = parseInt(document.getElementById('pjVillainyInput').value) || 0;
            const heroism = parseInt(document.getElementById('pjHeroismInput').value) || 0;
            const is_physical_talented = !!document.getElementById('pjIsPhysicalTalented').checked;
            const is_mental_talented = !!document.getElementById('pjIsMentalTalented').checked;
            const is_coordination_talented = !!document.getElementById('pjIsCoordinationTalented').checked;
            const is_energy_talented = !!document.getElementById('pjIsEnergyTalented').checked;
            const is_physical_skills_talented = !!document.getElementById('pjIsPhysicalSkillsTalented').checked;
            const is_mental_skills_talented = !!document.getElementById('pjIsMentalSkillsTalented').checked;
            const is_energy_skills_talented = !!document.getElementById('pjIsEnergySkillsTalented').checked;

            if (!name) { alert('El nombre es requerido'); return; }

            const payload = {
                name,
                weight,
                height,
                age,
                look,
                charisma,
                villainy,
                heroism,
                type,
                is_physical_talented,
                is_mental_talented,
                is_coordination_talented,
                is_energy_talented,
                is_physical_skills_talented,
                is_mental_skills_talented,
                is_energy_skills_talented
            };

            const btn = document.getElementById('btnCreatePJ');
            btn.disabled = true;
            btn.classList.add('loading');

            try {
                const res = await fetch(`${API_BASE_URL}/api/v1/campaigns/${currentInvitationCampaignId}/pjs`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.status === 401) { localStorage.removeItem('authToken'); window.location.href = 'login.html'; return; }

                if (res.status === 403) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || 'No est√°s autorizado para crear este personaje');
                }

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || `Error ${res.status}`);
                }

                const pj = await res.json();
                alert('Personaje creado correctamente: ' + pj.name);
                closeCreatePJModal();
                loadCharacters();
                loadInvitations();

            } catch (err) {
                console.error('Error creating PJ:', err);
                alert(err.message || 'Error al crear personaje');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }


        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('authToken');
            window.location.href = 'login.html';
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            updateUserInfo();
            loadCharacters();
        });
    </script>
</body>
</html>
