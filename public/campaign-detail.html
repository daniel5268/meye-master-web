<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de Campa√±a - Game Master</title>
    <script src="config.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/global.css">
    <link rel="stylesheet" href="styles/campaign.css">
</head>
<body>
    <!-- Background -->
    <div class="bg-grid"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Loading State -->
        <div id="loadingState" class="loading-container">
            <div class="spinner"></div>
            <div class="loading-text">Cargando campa√±a...</div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-container" style="display: none;">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h3 class="error-title">Error al cargar la campa√±a</h3>
            <p class="error-message" id="errorMessage"></p>
            <a href="/master-dashboard.html" class="btn-secondary" style="display: inline-block; text-decoration: none; margin-top: 16px;">
                Volver al Dashboard
            </a>
        </div>

        <!-- Campaign Content -->
        <div id="campaignContent" style="display: none;">
            <!-- Campaign Header -->
            <div class="campaign-header">
                <div class="header-top">
                    <div class="header-left">
                        <a href="/master-dashboard.html" class="btn-back">
                            <span>‚Üê</span>
                            <span>Volver a Campa√±as</span>
                        </a>
                        <h1 class="campaign-title" id="campaignName">Cargando...</h1>
                        <div class="campaign-meta">
                            <div class="meta-item">
                                <span class="meta-label">ID:</span>
                                <span class="meta-value" id="campaignId">-</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Master ID:</span>
                                <span class="meta-value" id="masterId">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="btn-secondary" onclick="openSessionModal()" style="margin-right: 12px;">
                            <span>üé≤</span>
                            <span>Crear Sesi√≥n</span>
                        </button>
                        <button class="btn-invite" onclick="openInviteModal()">
                            <span>‚úâÔ∏è</span>
                            <span>Invitar Jugador</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('pjs')">
                    Personajes
                    <span class="tab-badge" id="pjsCount">0</span>
                </button>
                <button class="tab" onclick="switchTab('invitations')">
                    Invitaciones
                    <span class="tab-badge" id="invitationsCount">0</span>
                </button>
                <button class="tab" onclick="switchTab('sessions')">
                    Sesiones
                    <span class="tab-badge" id="sessionsCount">0</span>
                </button>
            </div>

            <!-- Tab: Personajes -->
            <div id="tab-pjs" class="tab-content active">
                <div id="pjsEmpty" class="empty-state" style="display: none;">
                    <div class="empty-icon">üë§</div>
                    <h3 class="empty-title">No hay personajes a√∫n</h3>
                    <p class="empty-message">Los jugadores crear√°n sus personajes una vez acepten la invitaci√≥n.</p>
                </div>
                <div id="pjsList" class="pjs-list"></div>
            </div>

            <!-- Tab: Invitaciones -->
            <div id="tab-invitations" class="tab-content">
                <div id="invitationsEmpty" class="empty-state" style="display: none;">
                    <div class="empty-icon">‚úâÔ∏è</div>
                    <h3 class="empty-title">No hay invitaciones</h3>
                    <p class="empty-message">Invita jugadores para que se unan a tu campa√±a.</p>
                </div>
                <div id="invitationsList" class="invitations-list"></div>
            </div>

            <!-- Tab: Sesiones -->
            <div id="tab-sessions" class="tab-content">
                <div id="sessionsEmpty" class="empty-state" style="display: none;">
                    <div class="empty-icon">üé≤</div>
                    <h3 class="empty-title">No hay sesiones a√∫n</h3>
                    <p class="empty-message">Las sesiones de juego aparecer√°n aqu√≠ una vez que comiences a jugar.</p>
                </div>
                <div id="sessionsList" class="sessions-list"></div>
            </div>
        </div>
    </div>

    <!-- Invite Modal -->
    <div class="modal-overlay" id="inviteModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title-section">
                    <div class="modal-icon">‚úâÔ∏è</div>
                    <h3 class="modal-title">Invitar Jugador</h3>
                    <p class="modal-subtitle">Selecciona un jugador para invitar a la campa√±a</p>
                </div>
                <button class="btn-close" onclick="closeInviteModal()">√ó</button>
            </div>

            <div class="modal-body">
                <div id="modalAlert" class="modal-alert"></div>

                <!-- Players List -->
                <div id="playersLoading" class="loading-container" style="padding: 40px 20px;">
                    <div class="spinner"></div>
                    <div class="loading-text">Cargando jugadores...</div>
                </div>

                <div id="playersContent" style="display: none;">
                    <div id="playersList" class="players-list"></div>
                    
                    <!-- Pagination -->
                    <div class="pagination">
                        <button class="pagination-btn" id="btnPrevPage" onclick="loadPlayers(currentPage - 1)">
                            Anterior
                        </button>
                        <span class="pagination-info" id="paginationInfo">P√°gina 1</span>
                        <button class="pagination-btn" id="btnNextPage" onclick="loadPlayers(currentPage + 1)">
                            Siguiente
                        </button>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeInviteModal()">Cancelar</button>
                <button class="btn-primary" id="btnSendInvite" onclick="sendInvitation()" disabled>
                    <div class="btn-loader"></div>
                    <span class="btn-text">Enviar Invitaci√≥n</span>
                </button>
            </div>
        </div>
    </div>

    <!-- PJ Details Modal -->
    <div class="modal-overlay" id="pjModal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title-section">
                    <div class="modal-icon">üë§</div>
                    <h3 class="modal-title" id="pjModalName">Detalles del Personaje</h3>
                    <p class="modal-subtitle" id="pjModalType"></p>
                </div>
                <button class="btn-close" onclick="closePjModal()">√ó</button>
            </div>

            <div class="modal-body">
                <div id="pjModalContent" class="pj-modal-content">
                    <!-- Content will be dynamically loaded -->
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePjModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Create Session Modal -->
    <div class="modal-overlay" id="sessionModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title-section">
                    <div class="modal-icon">üé≤</div>
                    <h3 class="modal-title">Registrar Sesi√≥n</h3>
                    <p class="modal-subtitle">Documenta lo que sucedi√≥ y asigna experiencia</p>
                </div>
                <button class="btn-close" onclick="closeSessionModal()">√ó</button>
            </div>

            <div class="modal-body">
                <div id="sessionModalAlert" class="modal-alert"></div>

                <form id="sessionForm" onsubmit="return false;">
                    <!-- Summary -->
                    <div class="form-group">
                        <label for="sessionSummary">Resumen de la Sesi√≥n (Opcional)</label>
                        <textarea 
                            id="sessionSummary" 
                            name="sessionSummary"
                            placeholder="Describe lo que sucedi√≥ en esta sesi√≥n... (ej: El grupo derrot√≥ al drag√≥n y rescat√≥ a la princesa. Batalla √©pica con momentos cr√≠ticos.)"
                            maxlength="5000"
                        ></textarea>
                    </div>

                    <!-- XP Assignments -->
                    <div class="xp-form-section">
                        <div class="xp-form-title">‚≠ê Asignaci√≥n de Experiencia</div>
                        <div id="xpPjList" class="xp-pj-list">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeSessionModal()">Cancelar</button>
                <button class="btn-primary" id="btnCreateSession" onclick="createSession()">
                    <div class="btn-loader"></div>
                    <span class="btn-text">Crear Sesi√≥n</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = window?.ENV?.API_BASE_URL || 'http://localhost:3000';
        
        // Get campaign ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const campaignId = urlParams.get('id');

        // State
        let campaignData = null;
        let selectedPlayerId = null;
        let currentPage = 1;
        const pageSize = 10;

        // Auth check
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
                return null;
            }
            return token;
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show/Hide states
        function showLoading() {
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('campaignContent').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('campaignContent').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
        }

        function showContent() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('campaignContent').style.display = 'block';
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Load campaign details
        async function loadCampaign() {
            if (!campaignId) {
                showError('ID de campa√±a no proporcionado');
                return;
            }

            showLoading();
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/campaigns/${campaignId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login.html';
                    return;
                }

                if (response.status === 403) {
                    showError('No tienes permisos para ver esta campa√±a. Solo el master puede acceder.');
                    return;
                }

                if (response.status === 404) {
                    showError('Campa√±a no encontrada');
                    return;
                }

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || `Error ${response.status}`);
                }

                campaignData = await response.json();
                renderCampaign();
                showContent();

            } catch (error) {
                console.error('Error loading campaign:', error);
                showError(error.message || 'Error de conexi√≥n');
            }
        }

        // Render campaign data
        function renderCampaign() {
            // Header
            document.getElementById('campaignName').textContent = campaignData.name;
            document.getElementById('campaignId').textContent = campaignData.id.substring(0, 8) + '...';
            document.getElementById('masterId').textContent = campaignData.master_id.substring(0, 8) + '...';

            // Counts
            document.getElementById('pjsCount').textContent = campaignData.pjs?.length || 0;
            document.getElementById('invitationsCount').textContent = campaignData.invitations?.length || 0;
            document.getElementById('sessionsCount').textContent = campaignData.sessions?.length || 0;

            // Render PJs
            renderPJs();

            // Render Invitations
            renderInvitations();

            // Render Sessions
            renderSessions();
        }

        // Render PJs
        function renderPJs() {
            const pjsList = document.getElementById('pjsList');
            const pjsEmpty = document.getElementById('pjsEmpty');
            const pjs = campaignData.pjs || [];

            if (pjs.length === 0) {
                pjsEmpty.style.display = 'block';
                pjsList.innerHTML = '';
                return;
            }

            pjsEmpty.style.display = 'none';
            pjsList.innerHTML = pjs.map((pj, index) => `
                <div class="pj-list-item" onclick="openPjModal(${index})">
                    <div class="pj-list-info">
                        <div class="pj-list-name">${escapeHtml(pj.name)}</div>
                        <div class="pj-list-meta">
                            <span class="pj-type ${pj.pj_type}">${pj.pj_type === 'human' ? 'Humano' : 'Sobrenatural'}</span>
                            <span class="pj-list-stat">‚ù§Ô∏è Vida: <strong>${pj.basic_stats.life}</strong></span>
                            <span class="pj-list-stat">‚ö° Energ√≠a: <strong>${pj.special_stats.energy_tank}</strong></span>
                            <span class="pj-list-stat">XP Total: <strong>${pj.xp.basic + pj.xp.special + pj.xp.supernatural}</strong></span>
                        </div>
                    </div>
                    <button class="btn-view-pj" onclick="event.stopPropagation(); openPjModal(${index})">
                        Ver Detalles
                    </button>
                </div>
            `).join('');
        }

        // Open PJ Modal
        function openPjModal(index) {
            const pj = campaignData.pjs[index];
            if (!pj) return;

            // Update modal header
            document.getElementById('pjModalName').textContent = pj.name;
            document.getElementById('pjModalType').textContent = pj.pj_type === 'human' ? 'Personaje Humano' : 'Personaje Sobrenatural';

            // Generate modal content
            const content = `
                <!-- Caracter√≠sticas Personales -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">üë§ Caracter√≠sticas Personales</div>
                    <div class="pj-info-grid">
                        <div class="pj-info-item">
                            <div class="pj-info-label">Edad</div>
                            <div class="pj-info-value">${pj.age}</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Altura</div>
                            <div class="pj-info-value">${pj.height}cm</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Peso</div>
                            <div class="pj-info-value">${pj.weight}kg</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Apariencia</div>
                            <div class="pj-info-value">${pj.look}/20</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Carisma</div>
                            <div class="pj-info-value">${pj.charisma >= 0 ? '+' : ''}${pj.charisma}</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Villan√≠a</div>
                            <div class="pj-info-value">${pj.villainy}/10</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Hero√≠smo</div>
                            <div class="pj-info-value">${pj.heroism}/10</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">‚ù§Ô∏è Vida</div>
                            <div class="pj-info-value">${pj.basic_stats.life}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats F√≠sicos B√°sicos -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">üí™ Stats F√≠sicos B√°sicos ${pj.basic_stats.physical.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        <div class="pj-stat">
                            <div class="pj-stat-label">Fuerza</div>
                            <div class="pj-stat-value">${pj.basic_stats.physical.strength}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Agilidad</div>
                            <div class="pj-stat-value">${pj.basic_stats.physical.agility}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Velocidad</div>
                            <div class="pj-stat-value">${pj.basic_stats.physical.speed}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Resistencia</div>
                            <div class="pj-stat-value">${pj.basic_stats.physical.resistance}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats Mentales B√°sicos -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">üß† Stats Mentales B√°sicos ${pj.basic_stats.mental.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        <div class="pj-stat">
                            <div class="pj-stat-label">Inteligencia</div>
                            <div class="pj-stat-value">${pj.basic_stats.mental.intelligence}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Sabidur√≠a</div>
                            <div class="pj-stat-value">${pj.basic_stats.mental.wisdom}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Concentraci√≥n</div>
                            <div class="pj-stat-value">${pj.basic_stats.mental.concentration}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Voluntad</div>
                            <div class="pj-stat-value">${pj.basic_stats.mental.will}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats de Coordinaci√≥n B√°sicos -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">üéØ Stats de Coordinaci√≥n B√°sicos ${pj.basic_stats.coordination.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        <div class="pj-stat">
                            <div class="pj-stat-label">Precisi√≥n</div>
                            <div class="pj-stat-value">${pj.basic_stats.coordination.precision}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">C√°lculo</div>
                            <div class="pj-stat-value">${pj.basic_stats.coordination.calculation}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Alcance</div>
                            <div class="pj-stat-value">${pj.basic_stats.coordination.range}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Reflejos</div>
                            <div class="pj-stat-value">${pj.basic_stats.coordination.reflexes}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats F√≠sicos Especiales -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">üí• Habilidades F√≠sicas Especiales ${pj.special_stats.physical.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        <div class="pj-stat">
                            <div class="pj-stat-label">Potenciaci√≥n</div>
                            <div class="pj-stat-value">${pj.special_stats.physical.empowerment}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Control Vital</div>
                            <div class="pj-stat-value">${pj.special_stats.physical.vital_control}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats Mentales Especiales -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">üîÆ Habilidades Mentales Especiales ${pj.special_stats.mental.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        <div class="pj-stat">
                            <div class="pj-stat-label">Ilusi√≥n</div>
                            <div class="pj-stat-value">${pj.special_stats.mental.illusion}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Control Mental</div>
                            <div class="pj-stat-value">${pj.special_stats.mental.mental_control}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats de Energ√≠a Especiales -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">‚ö° Habilidades de Energ√≠a ${pj.special_stats.energy.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        <div class="pj-stat">
                            <div class="pj-stat-label">Manejo de Objetos</div>
                            <div class="pj-stat-value">${pj.special_stats.energy.object_handling}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Manejo de Energ√≠a</div>
                            <div class="pj-stat-value">${pj.special_stats.energy.energy_handling}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Tanque de Energ√≠a ${pj.special_stats.is_energy_talented ? '‚≠ê' : ''}</div>
                            <div class="pj-stat-value">${pj.special_stats.energy_tank}</div>
                        </div>
                    </div>
                </div>

                ${pj.pj_type === 'supernatural' && pj.supernatural_stats ? `
                <!-- Stats Sobrenaturales -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">‚ú® Habilidades Sobrenaturales</div>
                    ${pj.supernatural_stats.skills && pj.supernatural_stats.skills.length > 0 ? 
                        pj.supernatural_stats.skills.map((skill, skillIndex) => `
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 8px;">
                                    Habilidad ${skillIndex + 1}
                                </div>
                                <div class="pj-stats-grid">
                                    ${skill.transformations.map((power, transIndex) => `
                                        <div class="pj-stat">
                                            <div class="pj-stat-label">Nivel ${transIndex + 1}</div>
                                            <div class="pj-stat-value">${power}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')
                    : '<div style="text-align: center; color: var(--text-dim); font-size: 12px; padding: 10px;">Sin habilidades sobrenaturales</div>'}
                </div>
                ` : ''}

                <!-- XP -->
                <div class="pj-xp">
                    <div class="pj-xp-item">
                        <div class="pj-xp-label">XP B√°sico</div>
                        <div class="pj-xp-value">${pj.xp.basic}</div>
                    </div>
                    <div class="pj-xp-item">
                        <div class="pj-xp-label">XP Especial</div>
                        <div class="pj-xp-value">${pj.xp.special}</div>
                    </div>
                    <div class="pj-xp-item">
                        <div class="pj-xp-label">XP Sobrenatural</div>
                        <div class="pj-xp-value">${pj.xp.supernatural}</div>
                    </div>
                </div>
            `;

            document.getElementById('pjModalContent').innerHTML = content;
            document.getElementById('pjModal').classList.add('show');
        }

        // Close PJ Modal
        function closePjModal() {
            document.getElementById('pjModal').classList.remove('show');
        }

        // Close modal on overlay click
        document.getElementById('pjModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closePjModal();
            }
        });

        // Close modal on ESC (update existing listener)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('inviteModal').classList.contains('show')) {
                    closeInviteModal();
                }
                if (document.getElementById('pjModal').classList.contains('show')) {
                    closePjModal();
                }
            }
        });

        // Render Invitations
        function renderInvitations() {
            const invitationsList = document.getElementById('invitationsList');
            const invitationsEmpty = document.getElementById('invitationsEmpty');
            const invitations = campaignData.invitations || [];

            if (invitations.length === 0) {
                invitationsEmpty.style.display = 'block';
                invitationsList.innerHTML = '';
                return;
            }

            invitationsEmpty.style.display = 'none';
            invitationsList.innerHTML = invitations.map(invitation => `
                <div class="invitation-item">
                    <div class="invitation-info">
                        <div class="invitation-user">Usuario: ${invitation.user_id.substring(0, 8)}...</div>
                        <div class="invitation-id">ID Invitaci√≥n: ${invitation.id}</div>
                    </div>
                    <span class="invitation-status ${invitation.state}">${getInvitationStateLabel(invitation.state)}</span>
                </div>
            `).join('');
        }

        function getInvitationStateLabel(state) {
            const labels = {
                'pending': 'Pendiente',
                'accepted': 'Aceptada',
                'rejected': 'Rechazada'
            };
            return labels[state] || state;
        }

        // Render Sessions
        function renderSessions() {
            const sessionsList = document.getElementById('sessionsList');
            const sessionsEmpty = document.getElementById('sessionsEmpty');
            const sessions = campaignData.sessions || [];

            if (sessions.length === 0) {
                sessionsEmpty.style.display = 'block';
                sessionsList.innerHTML = '';
                return;
            }

            sessionsEmpty.style.display = 'none';
            
            // Sort sessions by date (most recent first)
            const sortedSessions = [...sessions].sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );

            sessionsList.innerHTML = sortedSessions.map((session, index) => {
                const date = new Date(session.created_at);
                const formattedDate = date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="session-card">
                        <div class="session-header">
                            <div class="session-title-section">
                                <div class="session-title">Sesi√≥n ${sortedSessions.length - index}</div>
                                <div class="session-date">üìÖ ${formattedDate}</div>
                            </div>
                            <div class="session-id">#${session.id.substring(0, 8)}</div>
                        </div>

                        ${session.summary ? `
                            <div class="session-summary">
                                ${escapeHtml(session.summary)}
                            </div>
                        ` : ''}

                        ${session.xp_assignations && session.xp_assignations.length > 0 ? `
                            <div class="session-xp-section">
                                <div class="session-xp-title">‚≠ê Experiencia Asignada</div>
                                <div class="xp-assignations-list">
                                    ${session.xp_assignations.map(assignment => {
                                        // Find PJ name
                                        const pj = campaignData.pjs?.find(p => p.id === assignment.pj_id);
                                        const pjName = pj ? pj.name : `PJ ${assignment.pj_id.substring(0, 8)}`;
                                        
                                        return `
                                            <div class="xp-assignation-item">
                                                <div class="xp-assignation-header">
                                                    <div class="xp-pj-name">${escapeHtml(pjName)}</div>
                                                    ${assignment.reason ? `
                                                        <div class="xp-reason">"${escapeHtml(assignment.reason)}"</div>
                                                    ` : ''}
                                                </div>
                                                <div class="xp-amounts">
                                                    <div class="xp-amount-item">
                                                        <div class="xp-amount-label">B√°sico</div>
                                                        <div class="xp-amount-value">+${assignment.amounts.basic}</div>
                                                    </div>
                                                    <div class="xp-amount-item">
                                                        <div class="xp-amount-label">Especial</div>
                                                        <div class="xp-amount-value">+${assignment.amounts.special}</div>
                                                    </div>
                                                    <div class="xp-amount-item">
                                                        <div class="xp-amount-label">Sobrenatural</div>
                                                        <div class="xp-amount-value">+${assignment.amounts.supernatural}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Modal functions
        function openInviteModal() {
            document.getElementById('inviteModal').classList.add('show');
            selectedPlayerId = null;
            currentPage = 1;
            updateInviteButton();
            loadPlayers(1);
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').classList.remove('show');
            hideModalAlert();
        }

        function showModalAlert(message, type = 'error') {
            const alert = document.getElementById('modalAlert');
            alert.textContent = message;
            alert.className = `modal-alert ${type} show`;
        }

        function hideModalAlert() {
            document.getElementById('modalAlert').classList.remove('show');
        }

        // Load players
        async function loadPlayers(page = 1) {
            const token = checkAuth();
            if (!token) return;

            document.getElementById('playersLoading').style.display = 'flex';
            document.getElementById('playersContent').style.display = 'none';
            hideModalAlert();

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/users/players?page=${page}&size=${pageSize}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar jugadores');
                }

                const data = await response.json();
                currentPage = data.page;
                renderPlayers(data.data || []);

                // Update pagination
                document.getElementById('paginationInfo').textContent = `P√°gina ${data.page}`;
                document.getElementById('btnPrevPage').disabled = data.page <= 1;
                document.getElementById('btnNextPage').disabled = (data.data || []).length < pageSize;

                document.getElementById('playersLoading').style.display = 'none';
                document.getElementById('playersContent').style.display = 'block';

            } catch (error) {
                console.error('Error loading players:', error);
                showModalAlert('Error al cargar la lista de jugadores', 'error');
                document.getElementById('playersLoading').style.display = 'none';
            }
        }

        function renderPlayers(players) {
            const playersList = document.getElementById('playersList');
            
            if (players.length === 0) {
                playersList.innerHTML = '<div class="empty-state"><div class="empty-message">No hay m√°s jugadores disponibles</div></div>';
                return;
            }

            playersList.innerHTML = players.map(player => `
                <div class="player-item ${selectedPlayerId === player.id ? 'selected' : ''}" onclick="selectPlayer('${player.id}')">
                    <div class="player-info">
                        <div class="player-username">${escapeHtml(player.username)}</div>
                        <div class="player-id">ID: ${player.id}</div>
                    </div>
                    <span class="player-role">${player.role}</span>
                </div>
            `).join('');
        }

        function selectPlayer(playerId) {
            selectedPlayerId = playerId;
            updateInviteButton();
            
            // Update UI
            document.querySelectorAll('.player-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.player-item').classList.add('selected');
        }

        function updateInviteButton() {
            document.getElementById('btnSendInvite').disabled = !selectedPlayerId;
        }

        // Send invitation
        async function sendInvitation() {
            if (!selectedPlayerId) return;

            const token = checkAuth();
            if (!token) return;

            const btnSend = document.getElementById('btnSendInvite');
            btnSend.classList.add('loading');
            btnSend.disabled = true;
            hideModalAlert();

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/campaigns/${campaignId}/invitations`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: selectedPlayerId
                    })
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login.html';
                    return;
                }

                if (response.status === 403) {
                    showModalAlert('No tienes permisos para invitar jugadores', 'error');
                    return;
                }

                if (response.status === 404) {
                    showModalAlert('Campa√±a o jugador no encontrado', 'error');
                    return;
                }

                if (response.status === 406) {
                    const error = await response.json().catch(() => ({}));
                    showModalAlert(error.error || 'El jugador ya fue invitado', 'error');
                    return;
                }

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || 'Error al enviar invitaci√≥n');
                }

                // Success!
                showModalAlert('¬°Invitaci√≥n enviada exitosamente!', 'success');
                
                setTimeout(() => {
                    closeInviteModal();
                    loadCampaign(); // Reload campaign to show new invitation
                }, 1500);

            } catch (error) {
                console.error('Error sending invitation:', error);
                showModalAlert(error.message || 'Error de conexi√≥n', 'error');
            } finally {
                btnSend.classList.remove('loading');
                btnSend.disabled = false;
            }
        }

        // Close modal on overlay click
        document.getElementById('inviteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeInviteModal();
            }
        });

        // Session Modal functions
        function openSessionModal() {
            const pjs = campaignData.pjs || [];
            
            if (pjs.length === 0) {
                alert('No hay personajes en la campa√±a. Invita jugadores primero.');
                return;
            }

            document.getElementById('sessionModal').classList.add('show');
            hideSessionModalAlert();
            
            // Populate PJ list for XP assignment
            const xpPjList = document.getElementById('xpPjList');
            xpPjList.innerHTML = pjs.map(pj => `
                <div class="xp-pj-card">
                    <div class="xp-pj-header">
                        <div class="xp-pj-name-section">
                            <div class="xp-pj-name">${escapeHtml(pj.name)}</div>
                            <div class="xp-pj-id">ID: ${pj.id.substring(0, 8)}...</div>
                        </div>
                        <span class="pj-type ${pj.pj_type}">${pj.pj_type === 'human' ? 'Humano' : 'Sobrenatural'}</span>
                    </div>
                    <div class="xp-inputs-grid">
                        <div class="xp-input-group">
                            <label class="xp-input-label">XP B√°sico</label>
                            <input 
                                type="number" 
                                class="xp-input" 
                                id="xp-basic-${pj.id}"
                                min="0" 
                                max="10000"
                                value="0"
                                placeholder="0"
                            >
                        </div>
                        <div class="xp-input-group">
                            <label class="xp-input-label">XP Especial</label>
                            <input 
                                type="number" 
                                class="xp-input" 
                                id="xp-special-${pj.id}"
                                min="0" 
                                max="10000"
                                value="0"
                                placeholder="0"
                            >
                        </div>
                        <div class="xp-input-group">
                            <label class="xp-input-label">XP Sobrenatural</label>
                            <input 
                                type="number" 
                                class="xp-input" 
                                id="xp-supernatural-${pj.id}"
                                min="0" 
                                max="10000"
                                value="0"
                                placeholder="0"
                            >
                        </div>
                    </div>
                    <div class="xp-input-group">
                        <label class="xp-input-label">Raz√≥n (Opcional)</label>
                        <input 
                            type="text" 
                            class="xp-reason-input" 
                            id="xp-reason-${pj.id}"
                            placeholder="ej: Excelente interpretaci√≥n del personaje"
                            maxlength="500"
                        >
                    </div>
                </div>
            `).join('');

            // Reset form
            document.getElementById('sessionSummary').value = '';
        }

        function closeSessionModal() {
            document.getElementById('sessionModal').classList.remove('show');
            document.getElementById('sessionForm').reset();
            hideSessionModalAlert();
        }

        function showSessionModalAlert(message, type = 'error') {
            const alert = document.getElementById('sessionModalAlert');
            alert.textContent = message;
            alert.className = `modal-alert ${type} show`;
        }

        function hideSessionModalAlert() {
            document.getElementById('sessionModalAlert').classList.remove('show');
        }

        // Create session
        async function createSession() {
            const token = checkAuth();
            if (!token) return;

            const btnCreate = document.getElementById('btnCreateSession');
            btnCreate.classList.add('loading');
            btnCreate.disabled = true;
            hideSessionModalAlert();

            try {
                const summary = document.getElementById('sessionSummary').value.trim();
                const pjs = campaignData.pjs || [];
                
                // Collect XP assignments
                const xpAssignations = [];
                for (const pj of pjs) {
                    const basic = parseInt(document.getElementById(`xp-basic-${pj.id}`).value) || 0;
                    const special = parseInt(document.getElementById(`xp-special-${pj.id}`).value) || 0;
                    const supernatural = parseInt(document.getElementById(`xp-supernatural-${pj.id}`).value) || 0;
                    const reason = document.getElementById(`xp-reason-${pj.id}`).value.trim();

                    // Only include if at least one XP value is greater than 0
                    if (basic > 0 || special > 0 || supernatural > 0) {
                        const assignment = {
                            pj_id: pj.id,
                            amounts: {
                                basic,
                                special,
                                supernatural
                            }
                        };

                        // Only add reason if provided
                        if (reason) {
                            assignment.reason = reason;
                        }

                        xpAssignations.push(assignment);
                    }
                }

                // Build request body
                const requestBody = {};
                
                // Only add summary if provided
                if (summary) {
                    requestBody.summary = summary;
                }

                // Add XP assignments if any
                if (xpAssignations.length > 0) {
                    requestBody.xp_assignations = xpAssignations;
                }

                // At least summary or XP assignments must be provided
                if (!summary && xpAssignations.length === 0) {
                    showSessionModalAlert('Debes proporcionar un resumen o asignar experiencia a al menos un personaje', 'error');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/api/v1/campaigns/${campaignId}/sessions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login.html';
                    return;
                }

                if (response.status === 403) {
                    showSessionModalAlert('No tienes permisos para crear sesiones. Solo el master puede registrar sesiones.', 'error');
                    return;
                }

                if (response.status === 404) {
                    const error = await response.json().catch(() => ({}));
                    showSessionModalAlert(error.error || 'Campa√±a o personaje no encontrado', 'error');
                    return;
                }

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || `Error ${response.status}`);
                }

                // Success!
                showSessionModalAlert('¬°Sesi√≥n registrada exitosamente!', 'success');
                
                setTimeout(() => {
                    closeSessionModal();
                    loadCampaign(); // Reload to show new session
                }, 1500);

            } catch (error) {
                console.error('Error creating session:', error);
                showSessionModalAlert(error.message || 'Error de conexi√≥n', 'error');
            } finally {
                btnCreate.classList.remove('loading');
                btnCreate.disabled = false;
            }
        }

        // Close modal on overlay click
        document.getElementById('sessionModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeSessionModal();
            }
        });

        // Update ESC listener to close all modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('inviteModal').classList.contains('show')) {
                    closeInviteModal();
                }
                if (document.getElementById('pjModal').classList.contains('show')) {
                    closePjModal();
                }
                if (document.getElementById('sessionModal').classList.contains('show')) {
                    closeSessionModal();
                }
            }
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadCampaign();
        });
    </script>
</body>
</html>
