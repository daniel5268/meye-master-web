<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de Campa√±a - Game Master</title>
    <script src="config.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0a0e27;
            --secondary: #1a1f3a;
            --accent: #00ff88;
            --accent-dim: #00cc6a;
            --text: #e8edf5;
            --text-dim: #8b95a8;
            --error: #ff3366;
            --warning: #ffaa00;
            --success: #00ff88;
            --surface: #141829;
            --border: rgba(0, 255, 136, 0.15);
            --hover: rgba(0, 255, 136, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Mono', monospace;
            background: var(--primary);
            color: var(--text);
            min-height: 100vh;
        }

        /* Animated background */
        .bg-grid {
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(0, 255, 136, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 136, 0.02) 1px, transparent 1px);
            background-size: 80px 80px;
            animation: gridMove 30s linear infinite;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(80px, 80px); }
        }

        .orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.2;
            z-index: 0;
            pointer-events: none;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 500px;
            height: 500px;
            background: var(--accent);
            top: -250px;
            right: -150px;
        }

        .orb-2 {
            width: 400px;
            height: 400px;
            background: #0066ff;
            bottom: -200px;
            left: -150px;
            animation-delay: 7s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(40px, -40px) scale(1.1); }
            66% { transform: translate(-40px, 40px) scale(0.9); }
        }

        /* Container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }

        /* Campaign Header */
        .campaign-header {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .header-left {
            flex: 1;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-back {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 16px;
            text-decoration: none;
        }

        .btn-back:hover {
            color: var(--accent);
            border-color: var(--accent);
            transform: translateX(-4px);
        }

        .campaign-title {
            font-family: 'Syne', sans-serif;
            font-size: 36px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 12px;
            letter-spacing: -1px;
        }

        .campaign-meta {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-dim);
        }

        .meta-label {
            font-weight: 500;
        }

        .meta-value {
            color: var(--accent);
            font-family: 'DM Mono', monospace;
        }

        .btn-invite {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
            border: none;
            border-radius: 10px;
            color: var(--primary);
            font-family: 'Syne', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-invite:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 255, 136, 0.4);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            border-bottom: 1px solid var(--border);
            animation: fadeIn 0.6s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .tab {
            padding: 14px 24px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-dim);
            font-family: 'DM Mono', monospace;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            color: var(--text);
            background: var(--hover);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            background: var(--secondary);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .tab.active .tab-badge {
            background: var(--accent);
            color: var(--primary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        /* Loading State */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: var(--text-dim);
        }

        /* Error State */
        .error-container {
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid rgba(255, 51, 102, 0.3);
            border-radius: 12px;
            padding: 32px;
            text-align: center;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .error-title {
            font-family: 'Syne', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--error);
            margin-bottom: 8px;
        }

        .error-message {
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 24px;
        }

        /* Empty State */
        .empty-state {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
        }

        .empty-icon {
            font-size: 56px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-title {
            font-family: 'Syne', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .empty-message {
            font-size: 14px;
            color: var(--text-dim);
        }

        /* PJ List */
        .pjs-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pj-list-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pj-list-item:hover {
            border-color: var(--accent);
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .pj-list-info {
            flex: 1;
        }

        .pj-list-name {
            font-family: 'Syne', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }

        .pj-list-meta {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pj-type {
            display: inline-block;
            padding: 4px 10px;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pj-type.human {
            color: #4a9eff;
            border-color: rgba(74, 158, 255, 0.3);
            background: rgba(74, 158, 255, 0.1);
        }

        .pj-type.supernatural {
            color: #ff4a9e;
            border-color: rgba(255, 74, 158, 0.3);
            background: rgba(255, 74, 158, 0.1);
        }

        .pj-list-stat {
            font-size: 13px;
            color: var(--text-dim);
        }

        .pj-list-stat strong {
            color: var(--accent);
            font-weight: 600;
        }

        .btn-view-pj {
            padding: 10px 20px;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-view-pj:hover {
            background: var(--accent);
            color: var(--primary);
            border-color: var(--accent);
        }

        /* PJ Modal */
        .pj-modal-content {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 8px;
        }

        .pj-modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .pj-modal-content::-webkit-scrollbar-track {
            background: var(--secondary);
            border-radius: 4px;
        }

        .pj-modal-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .pj-modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        .pj-info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .pj-info-item {
            background: var(--secondary);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .pj-info-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .pj-info-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .pj-stats-section {
            margin-bottom: 20px;
        }

        .pj-stats-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .pj-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .pj-stat {
            background: var(--primary);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .pj-stat-label {
            font-size: 10px;
            color: var(--text-dim);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .pj-stat-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--accent);
        }

        .pj-xp {
            display: flex;
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .pj-xp-item {
            flex: 1;
            background: var(--primary);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .pj-xp-label {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .pj-xp-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--warning);
        }

        /* Invitations List */
        .invitations-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .invitation-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .invitation-item:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .invitation-info {
            flex: 1;
        }

        .invitation-user {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
        }

        .invitation-id {
            font-size: 11px;
            color: var(--text-dim);
            font-family: 'DM Mono', monospace;
        }

        .invitation-status {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .invitation-status.pending {
            background: rgba(255, 170, 0, 0.1);
            color: var(--warning);
            border: 1px solid rgba(255, 170, 0, 0.3);
        }

        .invitation-status.accepted {
            background: rgba(0, 255, 136, 0.1);
            color: var(--success);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .invitation-status.rejected {
            background: rgba(255, 51, 102, 0.1);
            color: var(--error);
            border: 1px solid rgba(255, 51, 102, 0.3);
        }

        /* Sessions List */
        .sessions-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .session-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .session-card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .session-title-section {
            flex: 1;
        }

        .session-title {
            font-family: 'Syne', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }

        .session-date {
            font-size: 12px;
            color: var(--text-dim);
            font-family: 'DM Mono', monospace;
        }

        .session-id {
            font-size: 10px;
            color: var(--text-dim);
            font-family: 'DM Mono', monospace;
            padding: 4px 8px;
            background: var(--secondary);
            border-radius: 6px;
        }

        .session-summary {
            font-size: 14px;
            color: var(--text);
            line-height: 1.6;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--secondary);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
        }

        .session-xp-section {
            margin-top: 16px;
        }

        .session-xp-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .xp-assignations-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .xp-assignation-item {
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }

        .xp-assignation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .xp-pj-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
        }

        .xp-reason {
            font-size: 12px;
            color: var(--text-dim);
            font-style: italic;
        }

        .xp-amounts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .xp-amount-item {
            background: var(--secondary);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .xp-amount-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .xp-amount-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--warning);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(10, 14, 39, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 
                0 24px 80px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(0, 255, 136, 0.1) inset;
            animation: modalSlideUp 0.4s ease-out;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 28px;
        }

        .modal-title-section {
            flex: 1;
        }

        .modal-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 8px 24px rgba(0, 255, 136, 0.3);
            margin-bottom: 16px;
        }

        .modal-title {
            font-family: 'Syne', sans-serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: var(--text-dim);
        }

        .btn-close {
            width: 36px;
            height: 36px;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-close:hover {
            background: var(--error);
            border-color: var(--error);
            color: white;
            transform: rotate(90deg);
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-alert {
            padding: 14px 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 13px;
            display: none;
        }

        .modal-alert.show {
            display: block;
        }

        .modal-alert.error {
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid rgba(255, 51, 102, 0.3);
            color: var(--error);
        }

        .modal-alert.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--accent);
        }

        /* Players List */
        .players-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .player-item {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-item:hover {
            border-color: var(--accent);
            background: var(--primary);
            transform: translateX(4px);
        }

        .player-item.selected {
            border-color: var(--accent);
            background: rgba(0, 255, 136, 0.1);
        }

        .player-info {
            flex: 1;
        }

        .player-username {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .player-id {
            font-size: 11px;
            color: var(--text-dim);
            font-family: 'DM Mono', monospace;
        }

        .player-role {
            padding: 4px 10px;
            background: var(--primary);
            border-radius: 6px;
            font-size: 11px;
            color: var(--accent);
            font-weight: 500;
            text-transform: uppercase;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
        }

        .pagination-btn {
            padding: 8px 16px;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--accent);
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 13px;
            color: var(--text-dim);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-secondary {
            padding: 14px 24px;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        /* Session Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text);
            letter-spacing: 0.3px;
        }

        textarea {
            width: 100%;
            min-height: 100px;
            padding: 14px 16px;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 14px;
            transition: all 0.3s ease;
            outline: none;
            resize: vertical;
        }

        textarea:focus {
            border-color: var(--accent);
            background: rgba(26, 31, 58, 0.8);
            box-shadow: 
                0 0 0 3px rgba(0, 255, 136, 0.1),
                0 4px 12px rgba(0, 255, 136, 0.15);
        }

        textarea::placeholder {
            color: var(--text-dim);
            opacity: 0.6;
        }

        .xp-form-section {
            margin-bottom: 24px;
        }

        .xp-form-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .xp-pj-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: 400px;
            overflow-y: auto;
            padding: 4px;
        }

        .xp-pj-card {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .xp-pj-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .xp-pj-name-section {
            flex: 1;
        }

        .xp-pj-name {
            font-family: 'Syne', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
        }

        .xp-pj-id {
            font-size: 11px;
            color: var(--text-dim);
            font-family: 'DM Mono', monospace;
        }

        .xp-inputs-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .xp-input-group {
            display: flex;
            flex-direction: column;
        }

        .xp-input-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.3px;
        }

        .xp-input {
            padding: 10px 12px;
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 14px;
            transition: all 0.3s ease;
            outline: none;
        }

        .xp-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }

        .xp-reason-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            transition: all 0.3s ease;
            outline: none;
        }

        .xp-reason-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }

        .xp-reason-input::placeholder {
            color: var(--text-dim);
            opacity: 0.6;
            font-style: italic;
        }

        .btn-primary {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
            border: none;
            border-radius: 10px;
            color: var(--primary);
            font-family: 'Syne', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 255, 136, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary.loading .btn-loader {
            display: block;
        }

        .btn-primary.loading .btn-text {
            display: none;
        }

        .btn-loader {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid var(--primary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .campaign-header {
                padding: 24px;
            }

            .header-top {
                flex-direction: column;
                gap: 16px;
            }

            .header-actions {
                width: 100%;
                flex-direction: column;
            }

            .header-actions .btn-secondary,
            .header-actions .btn-invite {
                width: 100%;
                justify-content: center;
                margin: 0 !important;
            }

            .campaign-title {
                font-size: 28px;
            }

            .campaign-meta {
                flex-direction: column;
                gap: 12px;
            }

            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                white-space: nowrap;
            }

            .pj-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .pj-info-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .xp-inputs-grid {
                grid-template-columns: 1fr;
            }

            .xp-amounts {
                grid-template-columns: 1fr;
            }

            .modal {
                padding: 32px 24px;
                max-height: 90vh;
            }

            .modal-title {
                font-size: 22px;
            }

            .modal-footer {
                flex-direction: column-reverse;
            }

            .btn-secondary,
            .btn-primary {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Background -->
    <div class="bg-grid"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Loading State -->
        <div id="loadingState" class="loading-container">
            <div class="spinner"></div>
            <div class="loading-text">Cargando campa√±a...</div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-container" style="display: none;">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h3 class="error-title">Error al cargar la campa√±a</h3>
            <p class="error-message" id="errorMessage"></p>
            <a href="/master-dashboard.html" class="btn-secondary" style="display: inline-block; text-decoration: none; margin-top: 16px;">
                Volver al Dashboard
            </a>
        </div>

        <!-- Campaign Content -->
        <div id="campaignContent" style="display: none;">
            <!-- Campaign Header -->
            <div class="campaign-header">
                <div class="header-top">
                    <div class="header-left">
                        <a href="/master-dashboard.html" class="btn-back">
                            <span>‚Üê</span>
                            <span>Volver a Campa√±as</span>
                        </a>
                        <h1 class="campaign-title" id="campaignName">Cargando...</h1>
                        <div class="campaign-meta">
                            <div class="meta-item">
                                <span class="meta-label">ID:</span>
                                <span class="meta-value" id="campaignId">-</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Master ID:</span>
                                <span class="meta-value" id="masterId">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="btn-secondary" onclick="openSessionModal()" style="margin-right: 12px;">
                            <span>üé≤</span>
                            <span>Crear Sesi√≥n</span>
                        </button>
                        <button class="btn-invite" onclick="openInviteModal()">
                            <span>‚úâÔ∏è</span>
                            <span>Invitar Jugador</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('pjs')">
                    Personajes
                    <span class="tab-badge" id="pjsCount">0</span>
                </button>
                <button class="tab" onclick="switchTab('invitations')">
                    Invitaciones
                    <span class="tab-badge" id="invitationsCount">0</span>
                </button>
                <button class="tab" onclick="switchTab('sessions')">
                    Sesiones
                    <span class="tab-badge" id="sessionsCount">0</span>
                </button>
            </div>

            <!-- Tab: Personajes -->
            <div id="tab-pjs" class="tab-content active">
                <div id="pjsEmpty" class="empty-state" style="display: none;">
                    <div class="empty-icon">üë§</div>
                    <h3 class="empty-title">No hay personajes a√∫n</h3>
                    <p class="empty-message">Los jugadores crear√°n sus personajes una vez acepten la invitaci√≥n.</p>
                </div>
                <div id="pjsList" class="pjs-list"></div>
            </div>

            <!-- Tab: Invitaciones -->
            <div id="tab-invitations" class="tab-content">
                <div id="invitationsEmpty" class="empty-state" style="display: none;">
                    <div class="empty-icon">‚úâÔ∏è</div>
                    <h3 class="empty-title">No hay invitaciones</h3>
                    <p class="empty-message">Invita jugadores para que se unan a tu campa√±a.</p>
                </div>
                <div id="invitationsList" class="invitations-list"></div>
            </div>

            <!-- Tab: Sesiones -->
            <div id="tab-sessions" class="tab-content">
                <div id="sessionsEmpty" class="empty-state" style="display: none;">
                    <div class="empty-icon">üé≤</div>
                    <h3 class="empty-title">No hay sesiones a√∫n</h3>
                    <p class="empty-message">Las sesiones de juego aparecer√°n aqu√≠ una vez que comiences a jugar.</p>
                </div>
                <div id="sessionsList" class="sessions-list"></div>
            </div>
        </div>
    </div>

    <!-- Invite Modal -->
    <div class="modal-overlay" id="inviteModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title-section">
                    <div class="modal-icon">‚úâÔ∏è</div>
                    <h3 class="modal-title">Invitar Jugador</h3>
                    <p class="modal-subtitle">Selecciona un jugador para invitar a la campa√±a</p>
                </div>
                <button class="btn-close" onclick="closeInviteModal()">√ó</button>
            </div>

            <div class="modal-body">
                <div id="modalAlert" class="modal-alert"></div>

                <!-- Players List -->
                <div id="playersLoading" class="loading-container" style="padding: 40px 20px;">
                    <div class="spinner"></div>
                    <div class="loading-text">Cargando jugadores...</div>
                </div>

                <div id="playersContent" style="display: none;">
                    <div id="playersList" class="players-list"></div>
                    
                    <!-- Pagination -->
                    <div class="pagination">
                        <button class="pagination-btn" id="btnPrevPage" onclick="loadPlayers(currentPage - 1)">
                            Anterior
                        </button>
                        <span class="pagination-info" id="paginationInfo">P√°gina 1</span>
                        <button class="pagination-btn" id="btnNextPage" onclick="loadPlayers(currentPage + 1)">
                            Siguiente
                        </button>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeInviteModal()">Cancelar</button>
                <button class="btn-primary" id="btnSendInvite" onclick="sendInvitation()" disabled>
                    <div class="btn-loader"></div>
                    <span class="btn-text">Enviar Invitaci√≥n</span>
                </button>
            </div>
        </div>
    </div>

    <!-- PJ Details Modal -->
    <div class="modal-overlay" id="pjModal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title-section">
                    <div class="modal-icon">üë§</div>
                    <h3 class="modal-title" id="pjModalName">Detalles del Personaje</h3>
                    <p class="modal-subtitle" id="pjModalType"></p>
                </div>
                <button class="btn-close" onclick="closePjModal()">√ó</button>
            </div>

            <div class="modal-body">
                <div id="pjModalContent" class="pj-modal-content">
                    <!-- Content will be dynamically loaded -->
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePjModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Create Session Modal -->
    <div class="modal-overlay" id="sessionModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title-section">
                    <div class="modal-icon">üé≤</div>
                    <h3 class="modal-title">Registrar Sesi√≥n</h3>
                    <p class="modal-subtitle">Documenta lo que sucedi√≥ y asigna experiencia</p>
                </div>
                <button class="btn-close" onclick="closeSessionModal()">√ó</button>
            </div>

            <div class="modal-body">
                <div id="sessionModalAlert" class="modal-alert"></div>

                <form id="sessionForm" onsubmit="return false;">
                    <!-- Summary -->
                    <div class="form-group">
                        <label for="sessionSummary">Resumen de la Sesi√≥n (Opcional)</label>
                        <textarea 
                            id="sessionSummary" 
                            name="sessionSummary"
                            placeholder="Describe lo que sucedi√≥ en esta sesi√≥n... (ej: El grupo derrot√≥ al drag√≥n y rescat√≥ a la princesa. Batalla √©pica con momentos cr√≠ticos.)"
                            maxlength="5000"
                        ></textarea>
                    </div>

                    <!-- XP Assignments -->
                    <div class="xp-form-section">
                        <div class="xp-form-title">‚≠ê Asignaci√≥n de Experiencia</div>
                        <div id="xpPjList" class="xp-pj-list">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeSessionModal()">Cancelar</button>
                <button class="btn-primary" id="btnCreateSession" onclick="createSession()">
                    <div class="btn-loader"></div>
                    <span class="btn-text">Crear Sesi√≥n</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = window?.ENV?.API_BASE_URL || 'http://localhost:3000';
        
        // Get campaign ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const campaignId = urlParams.get('id');

        // State
        let campaignData = null;
        let selectedPlayerId = null;
        let currentPage = 1;
        const pageSize = 10;

        // Auth check
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
                return null;
            }
            return token;
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show/Hide states
        function showLoading() {
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('campaignContent').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('campaignContent').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
        }

        function showContent() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('campaignContent').style.display = 'block';
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Load campaign details
        async function loadCampaign() {
            if (!campaignId) {
                showError('ID de campa√±a no proporcionado');
                return;
            }

            showLoading();
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/campaigns/${campaignId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login.html';
                    return;
                }

                if (response.status === 403) {
                    showError('No tienes permisos para ver esta campa√±a. Solo el master puede acceder.');
                    return;
                }

                if (response.status === 404) {
                    showError('Campa√±a no encontrada');
                    return;
                }

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || `Error ${response.status}`);
                }

                campaignData = await response.json();
                renderCampaign();
                showContent();

            } catch (error) {
                console.error('Error loading campaign:', error);
                showError(error.message || 'Error de conexi√≥n');
            }
        }

        // Render campaign data
        function renderCampaign() {
            // Header
            document.getElementById('campaignName').textContent = campaignData.name;
            document.getElementById('campaignId').textContent = campaignData.id.substring(0, 8) + '...';
            document.getElementById('masterId').textContent = campaignData.master_id.substring(0, 8) + '...';

            // Counts
            document.getElementById('pjsCount').textContent = campaignData.pjs?.length || 0;
            document.getElementById('invitationsCount').textContent = campaignData.invitations?.length || 0;
            document.getElementById('sessionsCount').textContent = campaignData.sessions?.length || 0;

            // Render PJs
            renderPJs();

            // Render Invitations
            renderInvitations();

            // Render Sessions
            renderSessions();
        }

        // Render PJs
        function renderPJs() {
            const pjsList = document.getElementById('pjsList');
            const pjsEmpty = document.getElementById('pjsEmpty');
            const pjs = campaignData.pjs || [];

            if (pjs.length === 0) {
                pjsEmpty.style.display = 'block';
                pjsList.innerHTML = '';
                return;
            }

            pjsEmpty.style.display = 'none';
            pjsList.innerHTML = pjs.map((pj, index) => `
                <div class="pj-list-item" onclick="openPjModal(${index})">
                    <div class="pj-list-info">
                        <div class="pj-list-name">${escapeHtml(pj.name)}</div>
                        <div class="pj-list-meta">
                            <span class="pj-type ${pj.pj_type}">${pj.pj_type === 'human' ? 'Humano' : 'Sobrenatural'}</span>
                            <span class="pj-list-stat">‚ù§Ô∏è Vida: <strong>${pj.basic_stats.life}</strong></span>
                            <span class="pj-list-stat">‚ö° Energ√≠a: <strong>${pj.special_stats.energy_tank}</strong></span>
                            <span class="pj-list-stat">XP Total: <strong>${pj.xp.basic + pj.xp.special + pj.xp.supernatural}</strong></span>
                        </div>
                    </div>
                    <button class="btn-view-pj" onclick="event.stopPropagation(); openPjModal(${index})">
                        Ver Detalles
                    </button>
                </div>
            `).join('');
        }

        // Open PJ Modal
        function openPjModal(index) {
            const pj = campaignData.pjs[index];
            if (!pj) return;

            // Update modal header
            document.getElementById('pjModalName').textContent = pj.name;
            document.getElementById('pjModalType').textContent = pj.pj_type === 'human' ? 'Personaje Humano' : 'Personaje Sobrenatural';

            // Generate modal content
            const content = `
                <!-- Caracter√≠sticas Personales -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">üë§ Caracter√≠sticas Personales</div>
                    <div class="pj-info-grid">
                        <div class="pj-info-item">
                            <div class="pj-info-label">Edad</div>
                            <div class="pj-info-value">${pj.age}</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Altura</div>
                            <div class="pj-info-value">${pj.height}cm</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Peso</div>
                            <div class="pj-info-value">${pj.weight}kg</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Apariencia</div>
                            <div class="pj-info-value">${pj.look}/20</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Carisma</div>
                            <div class="pj-info-value">${pj.charisma >= 0 ? '+' : ''}${pj.charisma}</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Villan√≠a</div>
                            <div class="pj-info-value">${pj.villainy}/10</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">Hero√≠smo</div>
                            <div class="pj-info-value">${pj.heroism}/10</div>
                        </div>
                        <div class="pj-info-item">
                            <div class="pj-info-label">‚ù§Ô∏è Vida</div>
                            <div class="pj-info-value">${pj.basic_stats.life}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats F√≠sicos B√°sicos -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">üí™ Stats F√≠sicos B√°sicos ${pj.basic_stats.physical.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        <div class="pj-stat">
                            <div class="pj-stat-label">Fuerza</div>
                            <div class="pj-stat-value">${pj.basic_stats.physical.strength}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Agilidad</div>
                            <div class="pj-stat-value">${pj.basic_stats.physical.agility}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Velocidad</div>
                            <div class="pj-stat-value">${pj.basic_stats.physical.speed}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Resistencia</div>
                            <div class="pj-stat-value">${pj.basic_stats.physical.resistance}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats Mentales B√°sicos -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">üß† Stats Mentales B√°sicos ${pj.basic_stats.mental.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        <div class="pj-stat">
                            <div class="pj-stat-label">Inteligencia</div>
                            <div class="pj-stat-value">${pj.basic_stats.mental.intelligence}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Sabidur√≠a</div>
                            <div class="pj-stat-value">${pj.basic_stats.mental.wisdom}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Concentraci√≥n</div>
                            <div class="pj-stat-value">${pj.basic_stats.mental.concentration}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Voluntad</div>
                            <div class="pj-stat-value">${pj.basic_stats.mental.will}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats de Coordinaci√≥n B√°sicos -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">üéØ Stats de Coordinaci√≥n B√°sicos ${pj.basic_stats.coordination.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        <div class="pj-stat">
                            <div class="pj-stat-label">Precisi√≥n</div>
                            <div class="pj-stat-value">${pj.basic_stats.coordination.precision}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">C√°lculo</div>
                            <div class="pj-stat-value">${pj.basic_stats.coordination.calculation}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Alcance</div>
                            <div class="pj-stat-value">${pj.basic_stats.coordination.range}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Reflejos</div>
                            <div class="pj-stat-value">${pj.basic_stats.coordination.reflexes}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats F√≠sicos Especiales -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">üí• Habilidades F√≠sicas Especiales ${pj.special_stats.physical.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        <div class="pj-stat">
                            <div class="pj-stat-label">Potenciaci√≥n</div>
                            <div class="pj-stat-value">${pj.special_stats.physical.empowerment}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Control Vital</div>
                            <div class="pj-stat-value">${pj.special_stats.physical.vital_control}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats Mentales Especiales -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">üîÆ Habilidades Mentales Especiales ${pj.special_stats.mental.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        <div class="pj-stat">
                            <div class="pj-stat-label">Ilusi√≥n</div>
                            <div class="pj-stat-value">${pj.special_stats.mental.illusion}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Control Mental</div>
                            <div class="pj-stat-value">${pj.special_stats.mental.mental_control}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats de Energ√≠a Especiales -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">‚ö° Habilidades de Energ√≠a ${pj.special_stats.energy.is_talented ? '‚≠ê' : ''}</div>
                    <div class="pj-stats-grid">
                        <div class="pj-stat">
                            <div class="pj-stat-label">Manejo de Objetos</div>
                            <div class="pj-stat-value">${pj.special_stats.energy.object_handling}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Manejo de Energ√≠a</div>
                            <div class="pj-stat-value">${pj.special_stats.energy.energy_handling}</div>
                        </div>
                        <div class="pj-stat">
                            <div class="pj-stat-label">Tanque de Energ√≠a ${pj.special_stats.is_energy_talented ? '‚≠ê' : ''}</div>
                            <div class="pj-stat-value">${pj.special_stats.energy_tank}</div>
                        </div>
                    </div>
                </div>

                ${pj.pj_type === 'supernatural' && pj.supernatural_stats ? `
                <!-- Stats Sobrenaturales -->
                <div class="pj-stats-section">
                    <div class="pj-stats-title">‚ú® Habilidades Sobrenaturales</div>
                    ${pj.supernatural_stats.skills && pj.supernatural_stats.skills.length > 0 ? 
                        pj.supernatural_stats.skills.map((skill, skillIndex) => `
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 8px;">
                                    Habilidad ${skillIndex + 1}
                                </div>
                                <div class="pj-stats-grid">
                                    ${skill.transformations.map((power, transIndex) => `
                                        <div class="pj-stat">
                                            <div class="pj-stat-label">Nivel ${transIndex + 1}</div>
                                            <div class="pj-stat-value">${power}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')
                    : '<div style="text-align: center; color: var(--text-dim); font-size: 12px; padding: 10px;">Sin habilidades sobrenaturales</div>'}
                </div>
                ` : ''}

                <!-- XP -->
                <div class="pj-xp">
                    <div class="pj-xp-item">
                        <div class="pj-xp-label">XP B√°sico</div>
                        <div class="pj-xp-value">${pj.xp.basic}</div>
                    </div>
                    <div class="pj-xp-item">
                        <div class="pj-xp-label">XP Especial</div>
                        <div class="pj-xp-value">${pj.xp.special}</div>
                    </div>
                    <div class="pj-xp-item">
                        <div class="pj-xp-label">XP Sobrenatural</div>
                        <div class="pj-xp-value">${pj.xp.supernatural}</div>
                    </div>
                </div>
            `;

            document.getElementById('pjModalContent').innerHTML = content;
            document.getElementById('pjModal').classList.add('show');
        }

        // Close PJ Modal
        function closePjModal() {
            document.getElementById('pjModal').classList.remove('show');
        }

        // Close modal on overlay click
        document.getElementById('pjModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closePjModal();
            }
        });

        // Close modal on ESC (update existing listener)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('inviteModal').classList.contains('show')) {
                    closeInviteModal();
                }
                if (document.getElementById('pjModal').classList.contains('show')) {
                    closePjModal();
                }
            }
        });

        // Render Invitations
        function renderInvitations() {
            const invitationsList = document.getElementById('invitationsList');
            const invitationsEmpty = document.getElementById('invitationsEmpty');
            const invitations = campaignData.invitations || [];

            if (invitations.length === 0) {
                invitationsEmpty.style.display = 'block';
                invitationsList.innerHTML = '';
                return;
            }

            invitationsEmpty.style.display = 'none';
            invitationsList.innerHTML = invitations.map(invitation => `
                <div class="invitation-item">
                    <div class="invitation-info">
                        <div class="invitation-user">Usuario: ${invitation.user_id.substring(0, 8)}...</div>
                        <div class="invitation-id">ID Invitaci√≥n: ${invitation.id}</div>
                    </div>
                    <span class="invitation-status ${invitation.state}">${getInvitationStateLabel(invitation.state)}</span>
                </div>
            `).join('');
        }

        function getInvitationStateLabel(state) {
            const labels = {
                'pending': 'Pendiente',
                'accepted': 'Aceptada',
                'rejected': 'Rechazada'
            };
            return labels[state] || state;
        }

        // Render Sessions
        function renderSessions() {
            const sessionsList = document.getElementById('sessionsList');
            const sessionsEmpty = document.getElementById('sessionsEmpty');
            const sessions = campaignData.sessions || [];

            if (sessions.length === 0) {
                sessionsEmpty.style.display = 'block';
                sessionsList.innerHTML = '';
                return;
            }

            sessionsEmpty.style.display = 'none';
            
            // Sort sessions by date (most recent first)
            const sortedSessions = [...sessions].sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );

            sessionsList.innerHTML = sortedSessions.map((session, index) => {
                const date = new Date(session.created_at);
                const formattedDate = date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="session-card">
                        <div class="session-header">
                            <div class="session-title-section">
                                <div class="session-title">Sesi√≥n ${sortedSessions.length - index}</div>
                                <div class="session-date">üìÖ ${formattedDate}</div>
                            </div>
                            <div class="session-id">#${session.id.substring(0, 8)}</div>
                        </div>

                        ${session.summary ? `
                            <div class="session-summary">
                                ${escapeHtml(session.summary)}
                            </div>
                        ` : ''}

                        ${session.xp_assignations && session.xp_assignations.length > 0 ? `
                            <div class="session-xp-section">
                                <div class="session-xp-title">‚≠ê Experiencia Asignada</div>
                                <div class="xp-assignations-list">
                                    ${session.xp_assignations.map(assignment => {
                                        // Find PJ name
                                        const pj = campaignData.pjs?.find(p => p.id === assignment.pj_id);
                                        const pjName = pj ? pj.name : `PJ ${assignment.pj_id.substring(0, 8)}`;
                                        
                                        return `
                                            <div class="xp-assignation-item">
                                                <div class="xp-assignation-header">
                                                    <div class="xp-pj-name">${escapeHtml(pjName)}</div>
                                                    ${assignment.reason ? `
                                                        <div class="xp-reason">"${escapeHtml(assignment.reason)}"</div>
                                                    ` : ''}
                                                </div>
                                                <div class="xp-amounts">
                                                    <div class="xp-amount-item">
                                                        <div class="xp-amount-label">B√°sico</div>
                                                        <div class="xp-amount-value">+${assignment.amounts.basic}</div>
                                                    </div>
                                                    <div class="xp-amount-item">
                                                        <div class="xp-amount-label">Especial</div>
                                                        <div class="xp-amount-value">+${assignment.amounts.special}</div>
                                                    </div>
                                                    <div class="xp-amount-item">
                                                        <div class="xp-amount-label">Sobrenatural</div>
                                                        <div class="xp-amount-value">+${assignment.amounts.supernatural}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Modal functions
        function openInviteModal() {
            document.getElementById('inviteModal').classList.add('show');
            selectedPlayerId = null;
            currentPage = 1;
            updateInviteButton();
            loadPlayers(1);
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').classList.remove('show');
            hideModalAlert();
        }

        function showModalAlert(message, type = 'error') {
            const alert = document.getElementById('modalAlert');
            alert.textContent = message;
            alert.className = `modal-alert ${type} show`;
        }

        function hideModalAlert() {
            document.getElementById('modalAlert').classList.remove('show');
        }

        // Load players
        async function loadPlayers(page = 1) {
            const token = checkAuth();
            if (!token) return;

            document.getElementById('playersLoading').style.display = 'flex';
            document.getElementById('playersContent').style.display = 'none';
            hideModalAlert();

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/users/players?page=${page}&size=${pageSize}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar jugadores');
                }

                const data = await response.json();
                currentPage = data.page;
                renderPlayers(data.data || []);

                // Update pagination
                document.getElementById('paginationInfo').textContent = `P√°gina ${data.page}`;
                document.getElementById('btnPrevPage').disabled = data.page <= 1;
                document.getElementById('btnNextPage').disabled = (data.data || []).length < pageSize;

                document.getElementById('playersLoading').style.display = 'none';
                document.getElementById('playersContent').style.display = 'block';

            } catch (error) {
                console.error('Error loading players:', error);
                showModalAlert('Error al cargar la lista de jugadores', 'error');
                document.getElementById('playersLoading').style.display = 'none';
            }
        }

        function renderPlayers(players) {
            const playersList = document.getElementById('playersList');
            
            if (players.length === 0) {
                playersList.innerHTML = '<div class="empty-state"><div class="empty-message">No hay m√°s jugadores disponibles</div></div>';
                return;
            }

            playersList.innerHTML = players.map(player => `
                <div class="player-item ${selectedPlayerId === player.id ? 'selected' : ''}" onclick="selectPlayer('${player.id}')">
                    <div class="player-info">
                        <div class="player-username">${escapeHtml(player.username)}</div>
                        <div class="player-id">ID: ${player.id}</div>
                    </div>
                    <span class="player-role">${player.role}</span>
                </div>
            `).join('');
        }

        function selectPlayer(playerId) {
            selectedPlayerId = playerId;
            updateInviteButton();
            
            // Update UI
            document.querySelectorAll('.player-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.player-item').classList.add('selected');
        }

        function updateInviteButton() {
            document.getElementById('btnSendInvite').disabled = !selectedPlayerId;
        }

        // Send invitation
        async function sendInvitation() {
            if (!selectedPlayerId) return;

            const token = checkAuth();
            if (!token) return;

            const btnSend = document.getElementById('btnSendInvite');
            btnSend.classList.add('loading');
            btnSend.disabled = true;
            hideModalAlert();

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/campaigns/${campaignId}/invitations`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: selectedPlayerId
                    })
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login.html';
                    return;
                }

                if (response.status === 403) {
                    showModalAlert('No tienes permisos para invitar jugadores', 'error');
                    return;
                }

                if (response.status === 404) {
                    showModalAlert('Campa√±a o jugador no encontrado', 'error');
                    return;
                }

                if (response.status === 406) {
                    const error = await response.json().catch(() => ({}));
                    showModalAlert(error.error || 'El jugador ya fue invitado', 'error');
                    return;
                }

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || 'Error al enviar invitaci√≥n');
                }

                // Success!
                showModalAlert('¬°Invitaci√≥n enviada exitosamente!', 'success');
                
                setTimeout(() => {
                    closeInviteModal();
                    loadCampaign(); // Reload campaign to show new invitation
                }, 1500);

            } catch (error) {
                console.error('Error sending invitation:', error);
                showModalAlert(error.message || 'Error de conexi√≥n', 'error');
            } finally {
                btnSend.classList.remove('loading');
                btnSend.disabled = false;
            }
        }

        // Close modal on overlay click
        document.getElementById('inviteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeInviteModal();
            }
        });

        // Session Modal functions
        function openSessionModal() {
            const pjs = campaignData.pjs || [];
            
            if (pjs.length === 0) {
                alert('No hay personajes en la campa√±a. Invita jugadores primero.');
                return;
            }

            document.getElementById('sessionModal').classList.add('show');
            hideSessionModalAlert();
            
            // Populate PJ list for XP assignment
            const xpPjList = document.getElementById('xpPjList');
            xpPjList.innerHTML = pjs.map(pj => `
                <div class="xp-pj-card">
                    <div class="xp-pj-header">
                        <div class="xp-pj-name-section">
                            <div class="xp-pj-name">${escapeHtml(pj.name)}</div>
                            <div class="xp-pj-id">ID: ${pj.id.substring(0, 8)}...</div>
                        </div>
                        <span class="pj-type ${pj.pj_type}">${pj.pj_type === 'human' ? 'Humano' : 'Sobrenatural'}</span>
                    </div>
                    <div class="xp-inputs-grid">
                        <div class="xp-input-group">
                            <label class="xp-input-label">XP B√°sico</label>
                            <input 
                                type="number" 
                                class="xp-input" 
                                id="xp-basic-${pj.id}"
                                min="0" 
                                max="10000"
                                value="0"
                                placeholder="0"
                            >
                        </div>
                        <div class="xp-input-group">
                            <label class="xp-input-label">XP Especial</label>
                            <input 
                                type="number" 
                                class="xp-input" 
                                id="xp-special-${pj.id}"
                                min="0" 
                                max="10000"
                                value="0"
                                placeholder="0"
                            >
                        </div>
                        <div class="xp-input-group">
                            <label class="xp-input-label">XP Sobrenatural</label>
                            <input 
                                type="number" 
                                class="xp-input" 
                                id="xp-supernatural-${pj.id}"
                                min="0" 
                                max="10000"
                                value="0"
                                placeholder="0"
                            >
                        </div>
                    </div>
                    <div class="xp-input-group">
                        <label class="xp-input-label">Raz√≥n (Opcional)</label>
                        <input 
                            type="text" 
                            class="xp-reason-input" 
                            id="xp-reason-${pj.id}"
                            placeholder="ej: Excelente interpretaci√≥n del personaje"
                            maxlength="500"
                        >
                    </div>
                </div>
            `).join('');

            // Reset form
            document.getElementById('sessionSummary').value = '';
        }

        function closeSessionModal() {
            document.getElementById('sessionModal').classList.remove('show');
            document.getElementById('sessionForm').reset();
            hideSessionModalAlert();
        }

        function showSessionModalAlert(message, type = 'error') {
            const alert = document.getElementById('sessionModalAlert');
            alert.textContent = message;
            alert.className = `modal-alert ${type} show`;
        }

        function hideSessionModalAlert() {
            document.getElementById('sessionModalAlert').classList.remove('show');
        }

        // Create session
        async function createSession() {
            const token = checkAuth();
            if (!token) return;

            const btnCreate = document.getElementById('btnCreateSession');
            btnCreate.classList.add('loading');
            btnCreate.disabled = true;
            hideSessionModalAlert();

            try {
                const summary = document.getElementById('sessionSummary').value.trim();
                const pjs = campaignData.pjs || [];
                
                // Collect XP assignments
                const xpAssignations = [];
                for (const pj of pjs) {
                    const basic = parseInt(document.getElementById(`xp-basic-${pj.id}`).value) || 0;
                    const special = parseInt(document.getElementById(`xp-special-${pj.id}`).value) || 0;
                    const supernatural = parseInt(document.getElementById(`xp-supernatural-${pj.id}`).value) || 0;
                    const reason = document.getElementById(`xp-reason-${pj.id}`).value.trim();

                    // Only include if at least one XP value is greater than 0
                    if (basic > 0 || special > 0 || supernatural > 0) {
                        const assignment = {
                            pj_id: pj.id,
                            amounts: {
                                basic,
                                special,
                                supernatural
                            }
                        };

                        // Only add reason if provided
                        if (reason) {
                            assignment.reason = reason;
                        }

                        xpAssignations.push(assignment);
                    }
                }

                // Build request body
                const requestBody = {};
                
                // Only add summary if provided
                if (summary) {
                    requestBody.summary = summary;
                }

                // Add XP assignments if any
                if (xpAssignations.length > 0) {
                    requestBody.xp_assignations = xpAssignations;
                }

                // At least summary or XP assignments must be provided
                if (!summary && xpAssignations.length === 0) {
                    showSessionModalAlert('Debes proporcionar un resumen o asignar experiencia a al menos un personaje', 'error');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/api/v1/campaigns/${campaignId}/sessions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login.html';
                    return;
                }

                if (response.status === 403) {
                    showSessionModalAlert('No tienes permisos para crear sesiones. Solo el master puede registrar sesiones.', 'error');
                    return;
                }

                if (response.status === 404) {
                    const error = await response.json().catch(() => ({}));
                    showSessionModalAlert(error.error || 'Campa√±a o personaje no encontrado', 'error');
                    return;
                }

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || `Error ${response.status}`);
                }

                // Success!
                showSessionModalAlert('¬°Sesi√≥n registrada exitosamente!', 'success');
                
                setTimeout(() => {
                    closeSessionModal();
                    loadCampaign(); // Reload to show new session
                }, 1500);

            } catch (error) {
                console.error('Error creating session:', error);
                showSessionModalAlert(error.message || 'Error de conexi√≥n', 'error');
            } finally {
                btnCreate.classList.remove('loading');
                btnCreate.disabled = false;
            }
        }

        // Close modal on overlay click
        document.getElementById('sessionModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeSessionModal();
            }
        });

        // Update ESC listener to close all modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('inviteModal').classList.contains('show')) {
                    closeInviteModal();
                }
                if (document.getElementById('pjModal').classList.contains('show')) {
                    closePjModal();
                }
                if (document.getElementById('sessionModal').classList.contains('show')) {
                    closeSessionModal();
                }
            }
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadCampaign();
        });
    </script>
</body>
</html>
