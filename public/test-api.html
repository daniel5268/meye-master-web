<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Login</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff88;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #00ff88;
            border-radius: 8px;
        }
        button {
            background: #00ff88;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }
        button:hover {
            background: #00cc6a;
        }
        input {
            background: #1a1a1a;
            border: 1px solid #00ff88;
            color: #00ff88;
            padding: 8px;
            margin: 5px;
            border-radius: 5px;
            width: 200px;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .success { color: #00ff88; }
        .error { color: #ff3366; }
        .info { color: #ffaa00; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Test API Login</h1>

    <div class="test-section">
        <h2>1. ConfiguraciÃ³n</h2>
        <p>API Base URL: <input type="text" id="apiUrl" value="http://localhost:3000"></p>
        <button onclick="testConnection()">Test ConexiÃ³n</button>
        <pre id="connectionResult"></pre>
    </div>

    <div class="test-section">
        <h2>2. Test Login POST</h2>
        <p>Username: <input type="text" id="username" value="master"></p>
        <p>Password: <input type="password" id="password" value="HolaMundo1991*"></p>
        <button onclick="testLogin()">Test Login</button>
        <pre id="loginResult"></pre>
    </div>

    <div class="test-section">
        <h2>3. Decodificar Token JWT</h2>
        <p>Token: <input type="text" id="token" placeholder="Pega tu token aquÃ­" style="width: 400px;"></p>
        <button onclick="decodeToken()">Decodificar</button>
        <pre id="tokenResult"></pre>
    </div>

    <div class="test-section">
        <h2>4. Test GET Campaigns (con token)</h2>
        <button onclick="testCampaigns()">Test Campaigns</button>
        <pre id="campaignsResult"></pre>
    </div>

    <script>
        let currentToken = null;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            element.innerHTML = `<span class="${className}">[${timestamp}] ${message}</span>`;
        }

        async function testConnection() {
            const apiUrl = document.getElementById('apiUrl').value;
            log('connectionResult', 'Probando conexiÃ³n...', 'info');
            
            try {
                const response = await fetch(`${apiUrl}/api/v1/users/login`, {
                    method: 'OPTIONS'
                });
                
                log('connectionResult', `âœ… ConexiÃ³n exitosa\nStatus: ${response.status}\nCORS habilitado: ${response.headers.has('access-control-allow-origin')}`, 'success');
            } catch (error) {
                log('connectionResult', `âŒ Error de conexiÃ³n:\n${error.message}\n\nVerifica que:\n1. El backend estÃ© corriendo en ${apiUrl}\n2. CORS estÃ© habilitado`, 'error');
            }
        }

        async function testLogin() {
            const apiUrl = document.getElementById('apiUrl').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            log('loginResult', 'Enviando POST request...', 'info');
            
            try {
                const requestBody = { username, password };
                log('loginResult', `ðŸ“¤ REQUEST:\nPOST ${apiUrl}/api/v1/users/login\nBody: ${JSON.stringify(requestBody, null, 2)}\n\nEsperando respuesta...`, 'info');
                
                const response = await fetch(`${apiUrl}/api/v1/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentToken = data.token;
                    document.getElementById('token').value = data.token;
                    
                    // Decodificar token
                    const claims = parseJwt(data.token);
                    
                    log('loginResult', `âœ… LOGIN EXITOSO!\n\nðŸ“¥ RESPONSE:\nStatus: ${response.status}\n\nðŸŽ« Token recibido:\n${data.token.substring(0, 50)}...\n\nðŸ”“ Claims decodificados:\n${JSON.stringify(claims, null, 2)}\n\nðŸŽ­ Role: ${claims.role}\nðŸ‘¤ User ID: ${claims.user_id}\nðŸ“› Username: ${claims.username}`, 'success');
                } else {
                    log('loginResult', `âŒ LOGIN FALLIDO\n\nStatus: ${response.status}\nError: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('loginResult', `âŒ Error en request:\n${error.message}`, 'error');
            }
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return { error: 'Token invÃ¡lido' };
            }
        }

        function decodeToken() {
            const token = document.getElementById('token').value;
            
            if (!token) {
                log('tokenResult', 'âŒ Ingresa un token primero', 'error');
                return;
            }
            
            const claims = parseJwt(token);
            
            if (claims.error) {
                log('tokenResult', `âŒ ${claims.error}`, 'error');
            } else {
                log('tokenResult', `âœ… Token decodificado:\n\n${JSON.stringify(claims, null, 2)}\n\nðŸŽ­ Role: ${claims.role}\n${claims.role === 'master' ? 'âœ… Es MASTER - puede acceder a dashboard' : 'âŒ NO es master - no puede acceder a dashboard'}`, 'success');
            }
        }

        async function testCampaigns() {
            const apiUrl = document.getElementById('apiUrl').value;
            
            if (!currentToken) {
                log('campaignsResult', 'âŒ Primero debes hacer login para obtener un token', 'error');
                return;
            }
            
            log('campaignsResult', 'Obteniendo campaÃ±as...', 'info');
            
            try {
                log('campaignsResult', `ðŸ“¤ REQUEST:\nGET ${apiUrl}/api/v1/campaigns\nAuthorization: Bearer ${currentToken.substring(0, 30)}...\n\nEsperando respuesta...`, 'info');
                
                const response = await fetch(`${apiUrl}/api/v1/campaigns`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('campaignsResult', `âœ… CAMPAIGNS OBTENIDAS!\n\nðŸ“¥ RESPONSE:\nStatus: ${response.status}\nTotal de campaÃ±as: ${Array.isArray(data) ? data.length : 'N/A'}\n\nDatos:\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    log('campaignsResult', `âŒ ERROR\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('campaignsResult', `âŒ Error en request:\n${error.message}`, 'error');
            }
        }

        // Auto test connection on load
        window.onload = () => {
            testConnection();
        };
    </script>
</body>
</html>
